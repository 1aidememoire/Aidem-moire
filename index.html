<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <!-- PWA & Mobile viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Jeu de Mots">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f0f10" media="(prefers-color-scheme: dark)">
    <meta name="description" content="M√©morisez des mots et concepts avec flashcards, quiz et SRS.">

    <!-- PWA Manifest (inline via data URI) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple touch icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%234f46e5'/%3E%3Ctext y='.9em' font-size='80' x='10'%3Eüß†%3C/text%3E%3C/svg%3E">

    <title>Jeu de Mots - Pro Memory Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        /* --- CONFIGURATION GLOBALE & ANIMATIONS --- */
        body { 
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* UTILS */
        .soft-card {
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
        }

        .soft-input {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            transition: all 0.3s ease;
            color: #1f2937;
        }
        .soft-input:focus {
            background-color: #ffffff;
            border-color: #818cf8;
            box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.2);
            outline: none;
        }

        /* TOGGLE SWITCH CUSTOM */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        
        /* --- DARK MODE REVISIT√â --- */
        body.dark-mode { 
            background-color: #0f0f10; /* Zinc-950 approx */
            color: #e4e4e7; 
        }
        
        body.dark-mode .soft-card { 
            background-color: #18181b; /* Zinc-900 */
            border-color: #27272a;
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.5);
        }
        
        body.dark-mode .bg-white { background-color: #18181b; color: #e4e4e7; }
        body.dark-mode .bg-gray-50, body.dark-mode .bg-zinc-50 { background-color: #27272a; color: #a1a1aa; }
        body.dark-mode .bg-amber-50 { background-color: #451a03; color: #fbbf24; border-color: #78350f; }
        
        /* Inputs Dark Mode */
        body.dark-mode input[type="text"], 
        body.dark-mode input[type="number"], 
        body.dark-mode select, 
        body.dark-mode textarea,
        body.dark-mode .soft-input {
            background-color: #27272a;
            border-color: #52525b;
            color: #f4f4f5;
        }
        body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus {
            background-color: #3f3f46;
            border-color: #6366f1;
        }

        body.dark-mode .text-gray-500 { color: #9ca3af; }
        body.dark-mode .text-gray-600 { color: #d1d5db; }
        body.dark-mode .text-gray-700 { color: #e5e7eb; }
        body.dark-mode .text-gray-800 { color: #f4f4f5; }
        
        /* Tab Buttons Dark Mode */
        body.dark-mode .tab-button.inactive { 
            background-color: #27272a; 
            color: #71717a; 
            border: 1px solid #3f3f46;
        }
        body.dark-mode .tab-button.inactive:hover {
            background-color: #3f3f46;
            color: #e4e4e7;
        }

        /* --- CLASSES UTILITAIRES --- */
        .tab-button { @apply px-6 py-3 font-bold rounded-xl w-full text-center transition-all duration-300 text-sm uppercase tracking-wide; }
        .tab-button.active { @apply bg-indigo-600 text-white shadow-lg shadow-indigo-500/30 dark:shadow-none; }
        .tab-button.inactive { @apply bg-white border border-gray-200 text-gray-400 hover:bg-gray-50; }
        
        .preserve-lines { white-space: pre-line; }

        /* Draggable stuff */
        .layout-editor-container {
            position: relative; width: 100%; height: 400px;
            border: 2px dashed #e5e7eb; background-color: #f9fafb;
            border-radius: 16px; overflow: hidden;
        }
        body.dark-mode .layout-editor-container { border-color: #3f3f46; background-color: #18181b; }
        
        .draggable-placeholder {
            width: 100px; height: 100px; background-color: #6366f1; color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border-radius: 12px; position: absolute;
            cursor: move; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            user-select: none; z-index: 50;
        }
        .game-image-manual {
            position: absolute; max-height: 200px; width: auto; object-fit: contain;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 10;
        }

        /* Improved image display in game */
        .game-image {
            max-width: 100%;
            max-height: 300px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: zoom-in;
            transition: transform 0.2s ease;
        }
        .game-image:hover {
            transform: scale(1.02);
        }

        /* Images in source display */
        .source-image {
            max-width: 400px;
            max-height: 400px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            cursor: zoom-in;
        }

        /* Images in multiple choice */
        .mc-image {
            max-width: 100%;
            max-height: 120px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
        }

        /* Image preview thumbnails */
        .image-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 2px solid transparent;
        }
        .image-thumbnail:hover {
            transform: scale(1.05);
            border-color: #6366f1;
        }

        /* Zoom modal */
        #image-zoom-modal {
            backdrop-filter: blur(4px);
        }
        #zoomed-image {
            animation: zoomIn 0.2s ease-out;
        }
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Animations */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .combo-pop { animation: pop 0.3s ease-out; }
        .combo-fire { color: #f59e0b; text-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        
        @keyframes pulse-count { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .countdown-animate { animation: pulse-count 1s infinite ease-in-out; }
        
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .floating-element { animation: float 6s ease-in-out infinite; }

        /* Smooth accordion */
        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 500px; /* Arbitrary large height */
            opacity: 1;
        }
        /* ---- MOBILE / PWA ---- */
        /* Safe area insets pour iPhones avec encoche */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Emp√™che le zoom sur les inputs sur iOS */
        input, select, textarea {
            font-size: 16px !important;
        }

        /* Touch targets minimum 44px (guidelines Apple/Google) */
        button, [role="button"] {
            min-height: 44px;
        }

        /* D√©sactiver la mise en surbrillance bleue au tap sur mobile */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* Am√©lioration du scroll sur iOS */
        .overflow-y-auto {
            -webkit-overflow-scrolling: touch;
        }

        /* Mode standalone (lanc√© depuis l'√©cran d'accueil) */
        @media all and (display-mode: standalone) {
            #dark-mode-toggle {
                top: calc(env(safe-area-inset-top) + 12px);
            }
        }

        /* Bouton toggle dark mode fixe ajust√© pour mobile */
        @media (max-width: 640px) {
            #dark-mode-toggle {
                top: auto;
                bottom: calc(env(safe-area-inset-bottom) + 16px);
                right: 16px;
                padding: 10px 14px;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-50 dark:bg-zinc-950 selection:bg-indigo-100 selection:text-indigo-900 dark:text-zinc-200">

    <button id="dark-mode-toggle" class="fixed top-6 right-6 px-4 py-2 rounded-full bg-white dark:bg-zinc-800 text-gray-800 dark:text-gray-200 shadow-md border border-gray-200 dark:border-zinc-700 hover:scale-105 transition-transform z-50 text-sm font-medium">
        <span id="dark-mode-icon">üåô Mode Sombre</span>
    </button>

    <div id="countdown-overlay" class="hidden fixed inset-0 bg-zinc-900 z-[100] flex items-center justify-center flex-col text-white transition-opacity duration-500">
        <div id="countdown-number" class="text-[10rem] font-black countdown-animate text-indigo-500 opacity-100 leading-none">3</div>
        <p class="mt-8 text-2xl font-light text-zinc-400 tracking-[0.2em] uppercase">Pr√©parez-vous</p>
    </div>

    <div id="game-container" class="soft-card dark:bg-zinc-900 dark:border-zinc-800 p-8 md:p-10 rounded-[2rem] w-full max-w-5xl text-center flex flex-col items-center transition-all duration-500 relative overflow-hidden min-h-[600px]">
        
        <div class="absolute -top-20 -left-20 w-64 h-64 bg-indigo-200 dark:bg-indigo-900/30 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-50 pointer-events-none"></div>
        <div class="absolute -bottom-20 -right-20 w-64 h-64 bg-emerald-200 dark:bg-emerald-900/30 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-50 pointer-events-none"></div>

        <div id="custom-alert" class="hidden fixed inset-0 bg-gray-900/40 backdrop-blur-sm overflow-y-auto h-full w-full z-[60] flex items-center justify-center">
            <div class="relative mx-auto p-6 border-0 w-80 shadow-2xl rounded-2xl bg-white dark:bg-zinc-800">
                <div class="text-center">
                    <h3 id="alert-title" class="text-xl font-bold text-gray-900 dark:text-white mb-2">Alert</h3>
                    <p id="alert-message" class="text-sm text-gray-500 dark:text-gray-300 mb-6"></p>
                    <button id="alert-ok-button" class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-full w-full hover:bg-indigo-700 transition-colors">OK</button>
                </div>
            </div>
        </div>
        
        <div id="layout-editor-modal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm overflow-y-auto h-full w-full z-[55] flex items-center justify-center p-4">
            <div class="relative mx-auto p-8 w-full max-w-4xl shadow-2xl rounded-3xl bg-white dark:bg-zinc-800">
                <h3 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Configuration de la disposition</h3>
                <div id="layout-editor-area" class="layout-editor-container"></div>
                <div class="flex justify-end gap-4 mt-8">
                    <button id="cancel-layout-btn" class="px-6 py-2 bg-gray-200 dark:bg-zinc-700 text-gray-700 dark:text-gray-200 rounded-full hover:bg-gray-300 dark:hover:bg-zinc-600 transition-colors">Annuler</button>
                    <button id="save-layout-btn" class="px-8 py-2 bg-indigo-600 text-white font-bold rounded-full hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-all">Valider</button>
                </div>
            </div>
        </div>

        <div id="image-zoom-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 cursor-zoom-out" onclick="this.classList.add('hidden')">
            <img id="zoomed-image" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
            <button class="absolute top-6 right-6 text-white text-3xl hover:text-gray-300 transition-colors">&times;</button>
        </div>

        <div id="help-modal" class="hidden fixed inset-0 bg-gray-900/40 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div class="relative mx-auto p-8 border-0 w-full max-w-2xl shadow-2xl rounded-3xl bg-white dark:bg-zinc-800 max-h-[90vh] flex flex-col">
                <h3 class="text-2xl text-center font-bold text-indigo-600 dark:text-indigo-400 mb-4 flex-shrink-0">Comment √ßa marche ?</h3>
                <div class="overflow-y-auto flex-grow px-2 space-y-6 text-gray-600 dark:text-gray-300 text-sm text-left leading-relaxed">
                    <p class="text-base text-gray-800 dark:text-gray-100 font-medium">
                        Jeu de Mots est un outil interactif con√ßu pour vous aider √† apprendre. Le principe est simple : <strong>vous renseignez les informations que vous souhaitez m√©moriser</strong>, et le jeu s'occupe de cr√©er des exercices pour vous.
                    </p>
                    
                    <section>
                        <h4 class="font-bold text-gray-900 dark:text-white mb-2 text-lg">1. Importez vos donn√©es</h4>
                        <p>Copiez vos donn√©es depuis Excel ou un fichier texte, ou importez des images. Le jeu fonctionne par colonnes (Question | R√©ponse | Contexte).</p>
                    </section>
                    
                    <section>
                        <h4 class="font-bold text-gray-900 dark:text-white mb-2 text-lg">2. Choisissez votre mode</h4>
                        <ul class="list-disc ml-5 space-y-1">
                            <li><strong>Flashcards :</strong> Le classique recto/verso.</li>
                            <li><strong>Quiz (Saisie) :</strong> Tapez la r√©ponse exacte au clavier.</li>
                            <li><strong>QCM :</strong> S√©lectionnez la bonne r√©ponse parmi des choix g√©n√©r√©s.</li>
                            <li><strong>Texte √† trous :</strong> Devinez le mot manquant dans une phrase.</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h4 class="font-bold text-gray-900 dark:text-white mb-2 text-lg">3. Optimisez avec le SRS</h4>
                        <p>Activez l'option "M√©morisation" (SRS). L'algorithme d√©tectera vos erreurs et vous reposera les questions difficiles plus souvent pour ancrer l'information dans votre m√©moire √† long terme.</p>
                    </section>
                </div>
                <div class="mt-8 flex-shrink-0">
                    <button id="close-help-button" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-all">C'est parti !</button>
                </div>
            </div>
        </div>

        <div id="setup-screen" class="w-full relative z-10 text-left">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-2 text-gray-900 dark:text-indigo-500 tracking-tight transition-colors">Jeu de Mots</h1>
                <p id="help-link" class="text-indigo-500 dark:text-indigo-400 font-medium cursor-pointer hover:text-indigo-600 text-sm inline-flex items-center gap-1">
                    <span>‚ÑπÔ∏è</span> Comment √ßa marche ?
                </p>
            </div>
            
            <div class="w-full mb-6">
                <div class="flex gap-2 p-1 bg-gray-100 dark:bg-zinc-900 rounded-2xl mb-4 border border-transparent dark:border-zinc-800">
                    <button id="text-tab-btn" class="tab-button active">Donn√©es Texte</button>
                    <button id="image-tab-btn" class="tab-button inactive">Images</button>
                </div>
                
                <div id="text-tab-content">
                    <p class="text-xs text-gray-400 mb-2 ml-1">Exemple format : Source | Cible | Contexte | Mn√©motechnique</p>
                    <textarea id="word-input-all" class="soft-input w-full h-32 p-4 rounded-2xl text-sm font-mono resize-none shadow-inner" placeholder="Collez vos donn√©es ici..."></textarea>
                </div>

                <div id="image-tab-content" class="hidden">
                    <div class="mb-2 p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800/30 rounded-lg">
                        <p class="text-xs text-blue-700 dark:text-blue-400">
                            ‚ú® Les images sont automatiquement compress√©es et optimis√©es. Cliquez sur une image pendant le jeu pour l'agrandir en plein √©cran.
                        </p>
                    </div>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 dark:border-zinc-700 rounded-2xl cursor-pointer bg-gray-50 dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700/50 transition-colors">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <p class="mb-1 text-sm text-gray-500 dark:text-gray-400 font-semibold">Cliquez pour importer des images</p>
                            <p class="text-xs text-gray-400">JPG, PNG</p>
                        </div>
                        <input type="file" id="image-input" multiple accept="image/jpeg, image/png" class="hidden">
                    </label>
                    <div id="image-preview-container" class="mt-4 grid grid-cols-5 gap-3 max-h-32 overflow-y-auto p-2"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1 uppercase">Mode de jeu</label>
                    <div class="relative">
                        <select id="game-mode-select" class="soft-input w-full p-3 rounded-xl appearance-none font-semibold">
                            <option value="default">üéì Lecture Simple</option>
                            <option value="typing">‚å®Ô∏è Saisie (Quiz)</option>
                            <option value="flashcard">‚ö° Flashcards</option>
                            <option value="cloze">üß© Texte √† Trous</option>
                            <option value="mc" id="mc-option">‚úÖ Choix multiples</option>
                            <option value="mixed" id="mixed-option">üîÄ Mode Mixte</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">‚ñº</div>
                    </div>
                </div>
                <div class="flex items-end">
                    <button id="memory-preset-btn" class="w-full p-3 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400 font-bold rounded-xl border border-amber-200 dark:border-amber-800/50 hover:bg-amber-100 dark:hover:bg-amber-900/40 transition-colors text-sm">
                        ‚òÖ Preset M√©moire
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                
                <div class="bg-white dark:bg-zinc-800 p-5 rounded-2xl border border-gray-100 dark:border-zinc-700 shadow-sm transition-all">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-2">
                            <span>üß†</span> M√©morisation
                        </h3>
                        <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="memo-section-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 border-gray-300 dark:border-zinc-500"/>
                            <label for="memo-section-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-zinc-600 cursor-pointer"></label>
                        </div>
                    </div>

                    <div id="memo-options" class="accordion-content mt-0 space-y-4">
                         <div class="pt-4 mt-2 border-t border-gray-100 dark:border-zinc-700">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="timer-mode-checkbox" class="rounded text-indigo-600 focus:ring-indigo-500 bg-gray-100 dark:bg-zinc-700 border-gray-300 dark:border-zinc-600">
                                    <label for="timer-mode-checkbox" class="text-sm text-gray-700 dark:text-gray-300">Cadence Auto</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="timer-seconds" value="3" step="0.5" class="w-16 p-1 text-center text-sm border rounded bg-gray-50 dark:bg-zinc-700 border-gray-200 dark:border-zinc-600">
                                    <span class="text-xs text-gray-400">sec</span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between mb-3 bg-emerald-50 dark:bg-emerald-900/10 p-2 rounded-lg">
                                <label for="srs-mode-checkbox" class="text-sm font-bold text-emerald-700 dark:text-emerald-400 cursor-pointer">Mode SRS (Intelligent)</label>
                                <input type="checkbox" id="srs-mode-checkbox" class="h-5 w-5 text-emerald-600 rounded bg-white dark:bg-zinc-800 border-emerald-200 dark:border-emerald-800">
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="review-all-checkbox" class="rounded text-indigo-600 bg-gray-100 dark:bg-zinc-700">
                                    <label for="review-all-checkbox" class="text-sm text-gray-600 dark:text-gray-400">Limite de temps</label>
                                </div>
                                <input type="number" id="review-all-seconds" placeholder="60" class="w-16 p-1 text-center text-sm border rounded bg-gray-50 dark:bg-zinc-700 border-gray-200 dark:border-zinc-600">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-zinc-800 p-5 rounded-2xl border border-gray-100 dark:border-zinc-700 shadow-sm transition-all">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-emerald-600 dark:text-emerald-400 flex items-center gap-2">
                            <span>üîä</span> Audio & Voix
                        </h3>
                        <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="tts-checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 border-gray-300 dark:border-zinc-500"/>
                            <label for="tts-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-zinc-600 cursor-pointer"></label>
                        </div>
                    </div>

                    <div id="audio-options" class="accordion-content mt-0 space-y-4">
                        <div class="pt-4 mt-2 border-t border-gray-100 dark:border-zinc-700">
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Vitesse</span>
                                    <span id="tts-rate-value" class="text-xs font-mono bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-2 py-0.5 rounded">1.0x</span>
                                </div>
                                <input type="range" id="tts-rate" min="0.5" max="2.5" step="0.1" value="1" class="w-full h-1 bg-emerald-200 dark:bg-emerald-800 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Pause (s)</span>
                                    <span id="tts-interval-value" class="text-xs font-mono bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 px-2 py-0.5 rounded">0s</span>
                                </div>
                                <input type="range" id="tts-interval" min="0" max="2" step="0.1" value="0" class="w-full h-1 bg-indigo-200 dark:bg-indigo-800 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                            </div>

                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="tts-en-numbers" class="rounded text-emerald-600 bg-gray-100 dark:bg-zinc-700 border-gray-300 dark:border-zinc-600">
                                <label for="tts-en-numbers" class="text-xs text-gray-600 dark:text-gray-400">Lire les nombres en Anglais</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-5 bg-gray-100 dark:bg-zinc-800 rounded-2xl mb-6 border border-gray-200 dark:border-zinc-700 transition-colors">
                <p class="text-xs font-bold text-gray-400 uppercase mb-3">Mapping des Colonnes</p>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">Affich√© (Source)</label>
                        <select id="source-column-select" class="w-full p-2 bg-white dark:bg-zinc-700 border border-gray-200 dark:border-zinc-600 rounded-lg text-sm text-gray-700 dark:text-gray-200">
                            <option value="1">Colonne 1</option><option value="2">Colonne 2</option><option value="3">Colonne 3</option><option value="4">Colonne 4</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">R√©ponse (Cible)</label>
                        <select id="target-column-select" class="w-full p-2 bg-white dark:bg-zinc-700 border border-gray-200 dark:border-zinc-600 rounded-lg text-sm text-gray-700 dark:text-gray-200">
                            <option value="2">Colonne 2</option><option value="1">Colonne 1</option><option value="3">Colonne 3</option><option value="4">Colonne 4</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center justify-between mt-4 gap-2">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="in-order-checkbox" class="rounded text-indigo-600 bg-white dark:bg-zinc-700">
                        <label for="in-order-checkbox" class="text-xs text-gray-600 dark:text-gray-300">Ordre S√©quentiel</label>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500 dark:text-gray-400">Nombre de mots ou d'images :</span>
                        <select id="num-source-words-select" required class="p-1 bg-white dark:bg-zinc-700 border dark:border-zinc-600 rounded text-sm font-bold dark:text-white"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                    </div>

                    <div class="flex items-center gap-2 ml-auto">
                        <input type="checkbox" id="manual-layout-checkbox" class="rounded text-indigo-600 bg-white dark:bg-zinc-700">
                        <label for="manual-layout-checkbox" class="text-xs font-bold text-gray-600 dark:text-gray-300">Layout Manuel</label>
                        <button id="configure-layout-btn" class="hidden px-3 py-1 bg-amber-500 text-white text-[10px] uppercase font-bold rounded-full">Configurer</button>
                        <span id="layout-status" class="hidden text-[10px] text-emerald-500 font-bold">‚úì OK</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-center gap-4 mb-4">
                <div class="flex items-center gap-2 bg-white dark:bg-zinc-800 px-3 py-2 rounded-lg border border-gray-200 dark:border-zinc-700">
                    <label class="text-xs font-bold text-gray-500">D√©compte</label>
                    <select id="start-countdown-select" class="bg-transparent text-sm font-bold text-gray-800 dark:text-white outline-none">
                        <option value="0">Aucun</option>
                        <option value="3" selected>3s</option>
                        <option value="5">5s</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="keep-settings-checkbox" class="rounded text-indigo-600 bg-white dark:bg-zinc-700 border-gray-300 dark:border-zinc-600">
                    <label for="keep-settings-checkbox" class="text-xs text-gray-500 dark:text-gray-400">Sauvegarder config</label>
                </div>
            </div>

            <button id="start-button" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white font-extrabold text-lg rounded-2xl shadow-xl shadow-indigo-200 dark:shadow-none hover:shadow-2xl hover:scale-[1.01] transition-all duration-300">
                LANCER L'ENTRA√éNEMENT
            </button>
        </div>

        <div id="game-screen" class="hidden w-full relative z-10 flex flex-col h-full min-h-[500px] justify-between">
            
            <div>
                <div class="flex justify-between items-center mb-4 px-2">
                    <div id="combo-container" class="opacity-0 transition-opacity font-black text-2xl italic text-emerald-500 flex items-center gap-2">
                        <span class="text-sm not-italic font-normal text-gray-400 dark:text-gray-500">Combo</span>
                        <span id="combo-value">0</span> üî•
                    </div>
                    <div class="text-xs font-bold text-gray-400 tracking-wider uppercase" id="progress-display"></div>
                </div>

                <div class="w-full bg-gray-200 dark:bg-zinc-700 rounded-full h-2 mb-6 overflow-hidden">
                    <div id="progress-bar-fill" class="bg-indigo-500 h-2 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>

                <div class="flex justify-between items-center mb-6 px-2">
                    <button id="return-button" class="px-4 py-1.5 bg-white dark:bg-zinc-800 border-2 border-red-500 text-red-600 dark:text-red-400 text-xs font-bold rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">‚Üê Arr√™ter</button>
                    <div class="font-mono text-sm text-gray-400 dark:text-gray-500" id="timer-display">0.000s</div>
                </div>
            </div>

            <div id="game-area" class="relative flex-grow flex flex-col items-center justify-center w-full min-h-[300px]">
                <div id="word-display" class="w-full flex flex-wrap items-center justify-center gap-6 p-4 transition-all duration-500"></div>
                
                <div id="cloze-display" class="hidden text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-medium my-6 p-6 bg-gray-50 dark:bg-zinc-800 rounded-2xl border-l-4 border-indigo-400 leading-relaxed shadow-sm preserve-lines"></div>

                <div id="flashcard-reveal" class="invisible flex flex-col items-center my-4 p-4 rounded-2xl bg-white/60 dark:bg-zinc-800/60 backdrop-blur-md border border-white/20 dark:border-white/10 w-full max-w-lg">
                    <span id="target-word-display" class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white preserve-lines mb-2 text-center"></span>
                    <div id="mnemonic-display" class="hidden mt-2 w-full bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-800/30 p-2 rounded-lg text-sm text-amber-800 dark:text-amber-500 italic text-center">
                        <span id="mnemonic-text" class="preserve-lines block"></span>
                    </div>
                </div>
            </div>
            
            <div class="mt-auto w-full flex flex-col items-center pb-2">
                <div class="flex justify-center items-center gap-4 w-full mb-6">
                    <button id="show-hint-button" class="hidden px-4 py-2 bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-500 text-xs font-bold rounded-full border border-amber-100 dark:border-amber-800/30">Indice</button>
                    
                    <button id="show-word-button" class="hidden px-8 py-3 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 font-bold text-lg rounded-2xl border border-emerald-100 dark:border-emerald-800/30 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 transition-all">Voir R√©ponse</button>
                    
                    <button id="next-word-button" class="px-8 py-3 bg-indigo-600 text-white font-bold text-lg rounded-2xl shadow-lg shadow-indigo-200 dark:shadow-none hover:bg-indigo-700 hover:scale-105 transition-all">Suivant</button>
                </div>
                
                <input type="text" id="typing-input" class="soft-input hidden w-full max-w-md p-4 text-center text-xl rounded-2xl focus:ring-2 focus:ring-indigo-500 mb-4 dark:text-white" placeholder="Votre r√©ponse...">
                 
                <div id="multiple-choice-container" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-2xl"></div>
                <div id="game-instruction" class="text-gray-300 dark:text-gray-600 text-[10px] mt-4 font-medium tracking-wide uppercase">Espace = Suivant</div>
            </div>
        </div>
        
        <div id="end-screen" class="hidden w-full relative z-10">
            <h2 class="text-3xl font-extrabold mb-6 text-gray-800 dark:text-white">Session Termin√©e</h2>
            
            <div class="mb-8 flex flex-wrap gap-4 justify-center">
                <div class="bg-indigo-50 dark:bg-zinc-800 p-4 rounded-2xl w-32 border border-indigo-100 dark:border-zinc-700">
                    <span class="block text-indigo-400 text-[10px] uppercase font-bold mb-1">Temps</span>
                    <span id="final-time-display" class="text-xl font-bold text-indigo-700 dark:text-indigo-400"></span>
                </div>
                <div class="bg-emerald-50 dark:bg-zinc-800 p-4 rounded-2xl w-32 border border-emerald-100 dark:border-zinc-700">
                    <span class="block text-emerald-400 text-[10px] uppercase font-bold mb-1">Combo Max</span>
                    <span id="final-combo-display" class="text-xl font-bold text-emerald-600 dark:text-emerald-400"></span>
                </div>
            </div>

            <div id="analytics-container" class="w-full mb-6 text-left">
                <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 mb-2">Points √† revoir</h3>
                <div class="overflow-hidden border border-gray-100 dark:border-zinc-700 rounded-xl shadow-sm">
                    <table class="min-w-full bg-white dark:bg-zinc-800 text-sm">
                        <thead class="bg-gray-50 dark:bg-zinc-700">
                            <tr>
                                <th class="py-2 px-4 text-left font-semibold text-gray-600 dark:text-gray-300">Mot</th>
                                <th class="py-2 px-4 text-center font-semibold text-gray-600 dark:text-gray-300">Erreurs</th>
                                <th class="py-2 px-4 text-center font-semibold text-gray-600 dark:text-gray-300">Temps</th>
                            </tr>
                        </thead>
                        <tbody id="analytics-table-body" class="divide-y divide-gray-100 dark:divide-zinc-700"></tbody>
                    </table>
                </div>
            </div>

            <div class="w-full mb-6 p-4 bg-amber-50 dark:bg-amber-900/10 rounded-2xl border border-amber-100 dark:border-amber-800/30 flex flex-col items-center">
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-sm text-amber-800 dark:text-amber-500 font-bold">Entra√Ænement Cibl√©</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-amber-700 dark:text-amber-600">Rejouer les</span>
                    <input type="number" id="slow-replay-count" value="5" min="1" max="100" class="w-12 p-1 border border-amber-200 dark:border-amber-700 rounded text-center font-bold text-amber-800 dark:text-white bg-white dark:bg-zinc-700">
                    <span class="text-xs text-amber-700 dark:text-amber-600">plus difficiles</span>
                    <button id="replay-slow-btn" class="ml-2 px-4 py-1 bg-amber-500 text-white font-bold text-xs rounded-full hover:bg-amber-600 transition">Go</button>
                </div>
            </div>

            <div class="flex gap-4 justify-center mt-4">
                <button id="reset-button" class="px-6 py-3 bg-gray-100 dark:bg-zinc-700 text-gray-600 dark:text-gray-200 font-bold rounded-full hover:bg-gray-200 dark:hover:bg-zinc-600 transition">Accueil</button>
                <button id="replay-button" class="hidden px-6 py-3 bg-emerald-500 text-white font-bold rounded-full hover:bg-emerald-600 transition">Rejouer les erreurs</button>
            </div>
            
            <div class="mt-8 w-full">
                <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase text-left">Historique D√©taill√©</h3>
                <div class="overflow-x-auto max-h-40 overflow-y-auto border border-gray-100 dark:border-zinc-700 rounded-xl">
                    <table class="min-w-full bg-white dark:bg-zinc-800 text-xs">
                        <tbody id="history-table-body" class="divide-y divide-gray-100 dark:divide-zinc-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ELEMENTS DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        
        // Tabs
        const wordInputAll = document.getElementById('word-input-all');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const textTabBtn = document.getElementById('text-tab-btn');
        const imageTabBtn = document.getElementById('image-tab-btn');
        const textTabContent = document.getElementById('text-tab-content');
        const imageTabContent = document.getElementById('image-tab-content');
        
        // Config inputs
        const gameModeSelect = document.getElementById('game-mode-select');
        const memoryPresetBtn = document.getElementById('memory-preset-btn');
        const mcOption = document.getElementById('mc-option');
        const mixedOption = document.getElementById('mixed-option');
        const sourceColumnSelect = document.getElementById('source-column-select');
        const targetColumnSelect = document.getElementById('target-column-select');
        const inOrderCheckbox = document.getElementById('in-order-checkbox');
        const numSourceWordsSelect = document.getElementById('num-source-words-select');
        
        // Memorization Section
        const memoSectionToggle = document.getElementById('memo-section-toggle');
        const memoOptions = document.getElementById('memo-options');
        const srsModeCheckbox = document.getElementById('srs-mode-checkbox');
        const reviewAllCheckbox = document.getElementById('review-all-checkbox');
        const reviewAllSecondsInput = document.getElementById('review-all-seconds');
        const timerModeCheckbox = document.getElementById('timer-mode-checkbox');
        const timerSecondsInput = document.getElementById('timer-seconds');
        
        // Audio Section
        const ttsCheckbox = document.getElementById('tts-checkbox'); // Acts as toggle for section
        const audioOptions = document.getElementById('audio-options');
        const ttsRateInput = document.getElementById('tts-rate');
        const ttsRateValue = document.getElementById('tts-rate-value');
        const ttsIntervalInput = document.getElementById('tts-interval');
        const ttsIntervalValue = document.getElementById('tts-interval-value');
        const ttsEnNumbersCheckbox = document.getElementById('tts-en-numbers');

        // Other UI
        const startCountdownSelect = document.getElementById('start-countdown-select');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownNumber = document.getElementById('countdown-number');
        const keepSettingsCheckbox = document.getElementById('keep-settings-checkbox');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeIcon = document.getElementById('dark-mode-icon');
        
        // Layout Editor
        const manualLayoutCheckbox = document.getElementById('manual-layout-checkbox');
        const configureLayoutBtn = document.getElementById('configure-layout-btn');
        const layoutStatus = document.getElementById('layout-status');
        const layoutEditorModal = document.getElementById('layout-editor-modal');
        const layoutEditorArea = document.getElementById('layout-editor-area');
        const saveLayoutBtn = document.getElementById('save-layout-btn');
        const cancelLayoutBtn = document.getElementById('cancel-layout-btn');

        // Game Controls
        const startButton = document.getElementById('start-button');
        const progressDisplay = document.getElementById('progress-display');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const timerDisplay = document.getElementById('timer-display');
        const comboContainer = document.getElementById('combo-container');
        const comboValueDisplay = document.getElementById('combo-value');
        const wordDisplayContainer = document.getElementById('word-display');
        const clozeDisplay = document.getElementById('cloze-display');
        const flashcardReveal = document.getElementById('flashcard-reveal');
        const targetWordDisplay = document.getElementById('target-word-display');
        const mnemonicDisplay = document.getElementById('mnemonic-display');
        const mnemonicText = document.getElementById('mnemonic-text');
        
        const showWordButton = document.getElementById('show-word-button');
        const showHintButton = document.getElementById('show-hint-button');
        const nextWordButton = document.getElementById('next-word-button');
        const typingInput = document.getElementById('typing-input');
        const multipleChoiceContainer = document.getElementById('multiple-choice-container');

        // End Screen
        const finalTimeDisplay = document.getElementById('final-time-display');
        const finalComboDisplay = document.getElementById('final-combo-display');
        const historyTableBody = document.getElementById('history-table-body');
        const analyticsTableBody = document.getElementById('analytics-table-body');
        const replayButton = document.getElementById('replay-button');
        const resetButton = document.getElementById('reset-button');
        const returnButton = document.getElementById('return-button');
        const slowReplayCount = document.getElementById('slow-replay-count');
        const replaySlowBtn = document.getElementById('replay-slow-btn');

        // Modals
        const customAlert = document.getElementById('custom-alert');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOkButton = document.getElementById('alert-ok-button');
        const helpLink = document.getElementById('help-link');
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-button');

        // --- STATE VARIABLES ---
        let wordData = [];
        let playQueue = [];
        let currentQueueIndex = 0;
        let currentWordIndex = 0;
        let gameStarted = false;
        let startTime = 0;
        let timerInterval = null; 
        let masterTimer = null;
        let autoAdvanceTimeout = null;
        let currentCardStartTime = 0;
        let speakTimeoutId = null;
        let wordTimings = [];
        let wordStartTime = 0;
        let isWordRevealed = false;
        let isError = false;
        let savedLayout = null;
        
        // Settings State
        let isReviewAllMode = false;
        let isTimerMode = false;
        let isSrsMode = false;
        let activeGameMode = 'default';
        let numSourceWords = 1;
        let sourceColumn = '1';
        let targetColumn = '2';
        let currentCombo = 0;
        let maxCombo = 0;

        // --- DARK MODE LOGIC ---
        const applyDarkMode = (isDark) => {
            document.body.classList.toggle('dark-mode', isDark);
            // Sync Tailwind 'dark:' variants (requires 'dark' class on <html>)
            document.documentElement.classList.toggle('dark', isDark);
            darkModeIcon.textContent = isDark ? '‚òÄÔ∏è Mode Clair' : 'üåô Mode Sombre';
            localStorage.setItem('darkMode', isDark ? '1' : '0');
        };
        darkModeToggle.addEventListener('click', () => {
            const isDark = !document.body.classList.contains('dark-mode');
            applyDarkMode(isDark);
        });
        // Restore preference on load (or follow OS preference)
        const savedDark = localStorage.getItem('darkMode');
        if (savedDark !== null) {
            applyDarkMode(savedDark === '1');
        } else {
            applyDarkMode(window.matchMedia('(prefers-color-scheme: dark)').matches);
        }

        // --- ACCORDION UI LOGIC ---
        function toggleAccordion(element, isOpen) {
            if (isOpen) {
                element.classList.add('open');
            } else {
                element.classList.remove('open');
            }
        }

        memoSectionToggle.addEventListener('change', (e) => toggleAccordion(memoOptions, e.target.checked));
        ttsCheckbox.addEventListener('change', (e) => toggleAccordion(audioOptions, e.target.checked));

        // --- UTILS ---
        function showCustomAlert(title, message) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
        }
        alertOkButton.addEventListener('click', () => customAlert.classList.add('hidden'));
        helpLink.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeHelpButton.addEventListener('click', () => helpModal.classList.add('hidden'));

        // --- PRESET CHUNKING ---
        memoryPresetBtn.addEventListener('click', () => {
             numSourceWordsSelect.value = "3";
             gameModeSelect.value = "flashcard";
             memoSectionToggle.checked = true; // Open accordion
             toggleAccordion(memoOptions, true);
             timerModeCheckbox.checked = true;
             timerSecondsInput.value = "5";
             handleModeChange();
             showCustomAlert("Preset Activ√©", "Mode Chunking (3 mots) + Timer 5s activ√©.");
        });

        // --- TABS & DATA ---
        textTabBtn.addEventListener('click', () => switchTab('text'));
        imageTabBtn.addEventListener('click', () => switchTab('image'));
        
        function switchTab(tab) {
            if (tab === 'text') {
                textTabContent.classList.remove('hidden');
                imageTabContent.classList.add('hidden');
                textTabBtn.classList.add('active'); textTabBtn.classList.remove('inactive');
                imageTabBtn.classList.add('inactive'); imageTabBtn.classList.remove('active');
            } else {
                textTabContent.classList.add('hidden');
                imageTabContent.classList.remove('hidden');
                textTabBtn.classList.add('inactive'); textTabBtn.classList.remove('active');
                imageTabBtn.classList.add('active'); imageTabBtn.classList.remove('inactive');
            }
            checkMultipleChoiceAvailability();
        }

        imageInput.addEventListener('change', async (e) => {
            imagePreviewContainer.innerHTML = '';
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                const compressedBase64 = await compressImage(file, 1200, 0.85);
                
                const img = document.createElement('img');
                img.src = compressedBase64;
                img.className = 'image-thumbnail';
                img.title = 'Cliquer pour agrandir';
                img.onclick = () => zoomImage(compressedBase64);
                imagePreviewContainer.appendChild(img);
            }
            checkMultipleChoiceAvailability();
        });

        // --- IMAGE COMPRESSION & OPTIMIZATION ---
        function compressImage(file, maxSize = 1200, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Calculate new dimensions
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = Math.round((height * maxSize) / width);
                                width = maxSize;
                            } else {
                                width = Math.round((width * maxSize) / height);
                                height = maxSize;
                            }
                        }
                        
                        // Create canvas and compress
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // White background for transparent PNGs
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        
                        // Draw and compress
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressed = canvas.toDataURL('image/jpeg', quality);
                        
                        resolve(compressed);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- IMAGE ZOOM MODAL ---
        const imageZoomModal = document.getElementById('image-zoom-modal');
        const zoomedImage = document.getElementById('zoomed-image');
        
        function zoomImage(src) {
            zoomedImage.src = src;
            imageZoomModal.classList.remove('hidden');
        }
        
        // Make all game images zoomable
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('game-image') || 
                e.target.classList.contains('source-image')) {
                zoomImage(e.target.src);
            }
        });

        function checkMultipleChoiceAvailability() {
            let totalCount = 0;
            const isImageMode = !imageTabContent.classList.contains('hidden');
            if (isImageMode) totalCount = imageInput.files.length;
            else totalCount = wordInputAll.value.trim().split('\n').filter(r => r.trim()).length;
            
            const isMCAvailable = totalCount >= 4;
            mcOption.disabled = !isMCAvailable;
            mixedOption.disabled = totalCount < 10 || !isMCAvailable;
            
            if (mcOption.disabled && gameModeSelect.value === 'mc') gameModeSelect.value = 'default';
            if (mixedOption.disabled && gameModeSelect.value === 'mixed') gameModeSelect.value = 'default';
            handleModeChange();
        }
        wordInputAll.addEventListener('input', checkMultipleChoiceAvailability);

        // --- TTS UI ---
        ttsRateInput.addEventListener('input', () => ttsRateValue.textContent = ttsRateInput.value + 'x');
        ttsIntervalInput.addEventListener('input', () => ttsIntervalValue.textContent = ttsIntervalInput.value + 's');

        // --- TTS LOGIC ---
        const synth = window.speechSynthesis;
        function speakText(text, onComplete) {
            if (synth.speaking) synth.cancel();
            if (speakTimeoutId) clearTimeout(speakTimeoutId);

            if (!ttsCheckbox.checked || !text || text.startsWith('data:image')) {
                if(onComplete) onComplete();
                return;
            }

            const rate = parseFloat(ttsRateInput.value);
            const intervalSec = parseFloat(ttsIntervalInput.value);

            if (intervalSec > 0) {
                const cadenceMs = intervalSec * 1000;
                let chunks = [];
                const cleanText = text.trim();
                // Simple regex split for chunks
                if (/^[0-9\s.,]+$/.test(cleanText)) {
                    chunks = cleanText.split('').filter(c => /[0-9]/.test(c));
                } else {
                    chunks = cleanText.split(/[\s,.]+/).filter(c => c.trim() !== '');
                }

                let index = 0;
                const speakNextChunk = () => {
                    if (index >= chunks.length || !gameStarted) {
                        if(onComplete) onComplete();
                        return;
                    }
                    const chunk = chunks[index];
                    const u = new SpeechSynthesisUtterance(chunk);
                    u.rate = rate; 
                    if (ttsEnNumbersCheckbox.checked && /^[0-9]+$/.test(chunk)) u.lang = 'en-US';
                    
                    const chunkStartTime = Date.now();
                    u.onend = () => {
                        const elapsed = Date.now() - chunkStartTime;
                        const remainingWait = Math.max(0, cadenceMs - elapsed);
                        index++;
                        if (index < chunks.length && gameStarted) {
                            speakTimeoutId = setTimeout(speakNextChunk, remainingWait);
                        } else {
                            speakTimeoutId = setTimeout(() => { if(onComplete) onComplete(); }, remainingWait);
                        }
                    };
                    u.onerror = () => { index++; if (index < chunks.length && gameStarted) speakNextChunk(); else if(onComplete) onComplete(); };
                    synth.speak(u);
                };
                speakNextChunk();
            } else {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = rate;
                if (ttsEnNumbersCheckbox.checked && /^[0-9\s.,]+$/.test(text.trim())) utterance.lang = 'en-US';
                utterance.onend = () => { if(onComplete) onComplete(); };
                utterance.onerror = () => { if(onComplete) onComplete(); };
                synth.speak(utterance);
            }
        }

        // --- LAYOUT LOGIC (simplified) ---
        manualLayoutCheckbox.addEventListener('change', () => {
            const isChecked = manualLayoutCheckbox.checked;
            configureLayoutBtn.classList.toggle('hidden', !isChecked);
            if (!isChecked) { layoutStatus.classList.add('hidden'); savedLayout = null; }
        });
        
        configureLayoutBtn.addEventListener('click', () => {
            const n = parseInt(numSourceWordsSelect.value) || 1;
            layoutEditorArea.innerHTML = '';
            for (let i = 0; i < n; i++) {
                const div = document.createElement('div');
                div.className = 'draggable-placeholder';
                div.textContent = `IMG ${i + 1}`;
                div.dataset.index = i;
                div.style.left = (20 + i * 120) + 'px';
                div.style.top = '50px';
                addDragListeners(div, layoutEditorArea);
                layoutEditorArea.appendChild(div);
            }
            layoutEditorModal.classList.remove('hidden');
        });
        cancelLayoutBtn.addEventListener('click', () => layoutEditorModal.classList.add('hidden'));
        saveLayoutBtn.addEventListener('click', () => {
            const placeholders = layoutEditorArea.querySelectorAll('.draggable-placeholder');
            const newLayout = {};
            placeholders.forEach(el => {
                newLayout[el.dataset.index] = { left: el.style.left, top: el.style.top };
            });
            savedLayout = newLayout;
            layoutStatus.classList.remove('hidden');
            layoutEditorModal.classList.add('hidden');
        });

        // Drag handlers
        let activeDragEl = null; let dragOffsetX = 0, dragOffsetY = 0; let dragContainer = null;
        function addDragListeners(el, container) {
            el.addEventListener('mousedown', (e) => startDrag(e, el, container));
            el.addEventListener('touchstart', (e) => startDrag(e, el, container), {passive: false});
        }
        function startDrag(e, el, container) {
            activeDragEl = el; dragContainer = container;
            const rect = el.getBoundingClientRect();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            dragOffsetX = clientX - rect.left; dragOffsetY = clientY - rect.top;
            document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag, {passive: false}); document.addEventListener('touchend', endDrag);
        }
        function onDrag(e) {
            if (!activeDragEl) return;
            e.preventDefault();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const containerRect = dragContainer.getBoundingClientRect();
            let newX = clientX - containerRect.left - dragOffsetX;
            let newY = clientY - containerRect.top - dragOffsetY;
            newX = Math.max(0, Math.min(newX, containerRect.width - activeDragEl.offsetWidth));
            newY = Math.max(0, Math.min(newY, containerRect.height - activeDragEl.offsetHeight));
            activeDragEl.style.left = newX + 'px'; activeDragEl.style.top = newY + 'px';
        }
        function endDrag() {
            activeDragEl = null;
            document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag); document.removeEventListener('touchend', endDrag);
        }

        // --- DATA PROCESSING ---
        function parseTsv(text) {
            // Parse TSV en g√©rant les cellules multi-lignes d'Excel (encapsul√©es par des guillemets)
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let insideQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        // Guillemet √©chapp√© ""
                        currentCell += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote mode
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === '\t' && !insideQuotes) {
                    // Fin de cellule
                    currentRow.push(currentCell);
                    currentCell = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    // Fin de ligne
                    if (char === '\r' && nextChar === '\n') {
                        i++; // Skip \n in \r\n
                    }
                    currentRow.push(currentCell);
                    if (currentRow.some(c => c.trim())) { // Ignore empty rows
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                } else {
                    // Caract√®re normal (y compris \n √† l'int√©rieur d'une cellule)
                    currentCell += char;
                }
            }
            
            // Ajouter la derni√®re cellule/ligne si n√©cessaire
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell);
                if (currentRow.some(c => c.trim())) {
                    rows.push(currentRow);
                }
            }
            
            return rows;
        }
        async function processFiles(files) {
            return Promise.all(Array.from(files).map(f => new Promise(resolve => {
                const r = new FileReader();
                r.onload = e => resolve({ '1': e.target.result, '2': f.name.replace(/\.[^/.]+$/, "") });
                r.readAsDataURL(f);
            })));
        }
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // --- GAME LAUNCH ---
        startButton.addEventListener('click', async () => {
            if (manualLayoutCheckbox.checked && !savedLayout) return showCustomAlert("Attention", "Configurez la disposition manuelle ou d√©cochez l'option.");
            const isImage = !imageTabContent.classList.contains('hidden');
            if (isImage && imageInput.files.length === 0) return showCustomAlert('Erreur', 'S√©lectionnez des images.');
            if (!isImage && !wordInputAll.value.trim()) return showCustomAlert('Erreur', 'Collez du texte.');

            if (isImage) {
                wordData = await processFiles(imageInput.files);
                wordData.forEach(w => { w.srsLevel = 0; w.nextReview = 0; w['3']=''; w['4']=''; });
            } else {
                const raw = parseTsv(wordInputAll.value);
                wordData = raw.map((c, i) => ({ 
                    '1': c[0]||'', '2': c[1]||'', '3': c[2]||'', '4': c[3]||'', '5': c[4]||'',
                    id: i, srsLevel: 0, nextReview: 0 
                })).filter(o => Object.values(o).some(v => v && v.toString().trim()));
            }
            if (wordData.length === 0) return showCustomAlert('Erreur', 'Donn√©es vides.');

            // Params
            sourceColumn = sourceColumnSelect.value;
            targetColumn = targetColumnSelect.value;
            if (sourceColumn === targetColumn) return showCustomAlert('Erreur', 'Les colonnes Source et R√©ponse sont identiques.');

            activeGameMode = gameModeSelect.value;
            isReviewAllMode = reviewAllCheckbox.checked;
            isTimerMode = timerModeCheckbox.checked;
            isSrsMode = srsModeCheckbox.checked;
            if (activeGameMode === 'default') isSrsMode = false;
            
            // Check SRS/Timer toggle logic based on Accordion visibility
            if (!memoSectionToggle.checked) {
                isSrsMode = false;
                isTimerMode = false;
                isReviewAllMode = false;
            }

            numSourceWords = parseInt(numSourceWordsSelect.value) || 1;

            // Queue Gen
            playQueue = [];
            const indices = wordData.map((_, i) => i);
            if (activeGameMode === 'mixed') {
                const shuf = shuffle([...indices]);
                const mcN = Math.floor(wordData.length * 0.4);
                const flN = Math.floor(wordData.length * 0.3);
                const p1 = shuf.slice(0, mcN).map(i => ({index: i, mode: 'mc'}));
                const p2 = shuf.slice(mcN, mcN+flN).map(i => ({index: i, mode: 'flashcard'}));
                const p3 = shuf.slice(mcN+flN).map(i => ({index: i, mode: 'typing'}));
                playQueue = shuffle([...p1, ...p2, ...p3]);
            } else {
                if (isSrsMode) playQueue = indices;
                else playQueue = (inOrderCheckbox.checked && !isReviewAllMode) ? indices : shuffle(indices);
            }

            const countdownSeconds = parseInt(startCountdownSelect.value);
            if (countdownSeconds > 0) {
                setupScreen.classList.add('hidden');
                countdownOverlay.classList.remove('hidden');
                let count = countdownSeconds;
                countdownNumber.textContent = count;
                const interval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownNumber.textContent = count;
                    } else {
                        clearInterval(interval);
                        countdownOverlay.classList.add('hidden');
                        launchGameActual();
                    }
                }, 1000);
            } else {
                launchGameActual();
            }
        });

        function launchGameActual() {
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            endScreen.classList.add('hidden');
            
            if (manualLayoutCheckbox.checked) {
                wordDisplayContainer.classList.remove('flex', 'flex-wrap', 'justify-center', 'items-center');
                wordDisplayContainer.classList.add('game-display-manual');
            } else {
                wordDisplayContainer.classList.add('flex', 'flex-wrap', 'justify-center', 'items-center');
                wordDisplayContainer.classList.remove('game-display-manual');
            }

            currentQueueIndex = 0; currentWordIndex = 0; wordTimings = [];
            gameStarted = true; startTime = performance.now();
            currentCombo = 0; maxCombo = 0; updateComboDisplay();
            
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => { timerDisplay.textContent = ((performance.now() - startTime)/1000).toFixed(3) + 's'; }, 50);
            
            if (isReviewAllMode && memoSectionToggle.checked) {
                const sec = parseInt(reviewAllSecondsInput.value) || 60;
                masterTimer = setTimeout(endGame, sec * 1000);
            }
            nextWord(true);
        }

        // --- CORE GAMEPLAY ---
        function getNextSRSWord() {
            const now = wordTimings.length;
            const due = wordData.filter(w => w.nextReview <= now);
            if (due.length > 0) return due[Math.floor(Math.random() * due.length)].id;
            const sorted = [...wordData].sort((a,b) => a.srsLevel - b.srsLevel);
            const candidates = sorted.slice(0, Math.min(3, sorted.length));
            return candidates[Math.floor(Math.random() * candidates.length)].id;
        }

        function displayWord() {
            if (synth.speaking) synth.cancel();
            if (speakTimeoutId) clearTimeout(speakTimeoutId);
            if (autoAdvanceTimeout) clearTimeout(autoAdvanceTimeout);

            isWordRevealed = false; isError = false;
            
            // UI Reset
            wordDisplayContainer.innerHTML = '';
            clozeDisplay.classList.add('hidden'); clozeDisplay.innerHTML = '';
            targetWordDisplay.textContent = '';
            mnemonicDisplay.classList.add('hidden');
            typingInput.classList.add('hidden');
            multipleChoiceContainer.classList.add('hidden');
            showWordButton.classList.add('hidden');
            showHintButton.classList.add('hidden');
            nextWordButton.classList.remove('hidden');
            flashcardReveal.classList.add('invisible');
            typingInput.value = '';
            typingInput.classList.remove('border-green-500', 'bg-green-50', 'border-red-500', 'bg-red-50');
            
            let textToRead = "";
            let wordObj = wordData[currentWordIndex];

            // Handling multiple cards display (chunking)
            const cardsToShow = [];
            if (!isSrsMode && numSourceWords > 1) {
                for (let i = 0; i < numSourceWords; i++) {
                    let idxInQueue = currentQueueIndex + i;
                    if (idxInQueue < playQueue.length) {
                         let realIdx = activeGameMode === 'mixed' ? playQueue[idxInQueue].index : playQueue[idxInQueue];
                         cardsToShow.push(wordData[realIdx]);
                    }
                }
            } else {
                cardsToShow.push(wordObj);
            }

            // Render cards
            cardsToShow.forEach((obj, i) => {
                const content = obj[sourceColumn];
                if (!content.startsWith('data:image')) textToRead += content + ". ";

                if (content.startsWith('data:image')) {
                     const img = document.createElement('img');
                     img.src = content;
                     img.title = 'Cliquer pour agrandir';
                     if (manualLayoutCheckbox.checked && savedLayout && savedLayout[i]) {
                        img.className = 'game-image-manual source-image rounded-xl shadow-md border border-white/50';
                        img.style.left = savedLayout[i].left; img.style.top = savedLayout[i].top;
                        wordDisplayContainer.appendChild(img);
                     } else {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'p-4 bg-white dark:bg-zinc-800 rounded-2xl shadow-lg border border-gray-100 dark:border-zinc-700 transition-transform hover:scale-[1.02] duration-300';
                        img.className = 'source-image';
                        wrapper.appendChild(img);
                        wordDisplayContainer.appendChild(wrapper);
                     }
                } else {
                    const p = document.createElement('p');
                    p.className = 'text-5xl md:text-6xl font-bold text-gray-800 dark:text-gray-100 break-words preserve-lines mx-4 tracking-tight leading-tight floating-element';
                    p.textContent = content;
                    if (manualLayoutCheckbox.checked && savedLayout && savedLayout[i]) {
                         p.style.position = 'absolute';
                         p.style.left = savedLayout[i].left; p.style.top = savedLayout[i].top;
                         p.classList.remove('floating-element'); 
                    }
                    wordDisplayContainer.appendChild(p);
                }
            });

            // Progress Bar
            let pct = 0;
            if(isSrsMode) {
                 const learned = wordData.filter(w => w.srsLevel >= 3).length;
                 pct = (learned / wordData.length) * 100;
                 progressDisplay.textContent = `SRS: ${learned}/${wordData.length}`;
            } else {
                 pct = (currentQueueIndex / playQueue.length) * 100;
                 progressDisplay.textContent = `${currentQueueIndex+1} / ${playQueue.length}`;
            }
            progressBarFill.style.width = pct + "%";

            // Mode Logic
            let mode = activeGameMode;
            if (activeGameMode === 'mixed') mode = playQueue[currentQueueIndex].mode;

            if (mode === 'cloze') {
                const sentence = wordObj['3'];
                const target = wordObj[targetColumn];
                if (sentence && sentence.trim().length > 0) {
                    clozeDisplay.classList.remove('hidden');
                    const regex = new RegExp(target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    
                    // Split by target word while preserving line breaks
                    const parts = sentence.split(regex);
                    clozeDisplay.textContent = ''; // Clear
                    
                    parts.forEach((part, idx) => {
                        const textNode = document.createTextNode(part);
                        clozeDisplay.appendChild(textNode);
                        
                        if (idx < parts.length - 1) {
                            const blank = document.createElement('span');
                            blank.className = 'text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-400 font-bold';
                            blank.textContent = '[...]';
                            clozeDisplay.appendChild(blank);
                        }
                    });
                    
                    textToRead = sentence.replace(regex, "blank");
                } else {
                    clozeDisplay.classList.remove('hidden');
                    clozeDisplay.innerHTML = "<em class='text-gray-400'>Erreur: Pas de phrase contextuelle.</em>";
                }
                typingInput.classList.remove('hidden');
                nextWordButton.innerHTML = 'Valider';
                setTimeout(() => typingInput.focus(), 100);
            }
            else if (mode === 'typing') {
                typingInput.classList.remove('hidden');
                nextWordButton.innerHTML = 'Valider';
                setTimeout(() => typingInput.focus(), 100);
            } 
            else if (mode === 'mc') {
                multipleChoiceContainer.classList.remove('hidden');
                nextWordButton.classList.add('hidden');
                displayMC(wordObj);
            } 
            else { 
                showWordButton.classList.remove('hidden');
                nextWordButton.innerHTML = 'Suivant';
            }

            if (isTimerMode) {
                showWordButton.classList.add('hidden');
                nextWordButton.classList.add('hidden');
                typingInput.classList.add('hidden');
            }
            
            if (wordObj['3'] || wordObj['4']) showHintButton.classList.remove('hidden');

            wordStartTime = performance.now();
            currentCardStartTime = Date.now();

            // Audio / Timer logic
            let minTimeMs = 0;
            if (isTimerMode) {
                const sec = parseFloat(timerSecondsInput.value) || 3;
                minTimeMs = sec * 1000;
            }

            const onAudioFinished = () => {
                if (!gameStarted || !isTimerMode) return;
                const elapsed = Date.now() - currentCardStartTime;
                const remaining = Math.max(0, minTimeMs - elapsed);
                autoAdvanceTimeout = setTimeout(() => { nextWord(); }, remaining);
            };

            if (textToRead && ttsCheckbox.checked) {
                speakText(textToRead, onAudioFinished);
            } else {
                if (isTimerMode) autoAdvanceTimeout = setTimeout(() => nextWord(), minTimeMs);
            }
        }

        function nextWord(isStart = false) {
            if (!isStart) {
                const timeSpent = performance.now() - wordStartTime;
                const wordObj = wordData[currentWordIndex];
                
                // SRS Update
                if (isSrsMode) {
                    if (activeGameMode === 'flashcard' && isWordRevealed) isError = true;
                    if (isError) {
                        wordObj.srsLevel = 0;
                        wordObj.nextReview = wordTimings.length + 1;
                        updateCombo(false);
                    } else {
                        wordObj.srsLevel++;
                        const jump = Math.pow(2, wordObj.srsLevel) + 1;
                        wordObj.nextReview = wordTimings.length + jump;
                        updateCombo(true);
                    }
                }
                
                wordTimings.push({ 
                    ...wordObj, 
                    time: timeSpent, 
                    isError: isError,
                    targetLabel: wordObj[targetColumn] 
                });

                if (!isSrsMode) currentQueueIndex += numSourceWords;
            }

            // Check End Condition
            if (!isSrsMode && currentQueueIndex >= playQueue.length) {
                if (isReviewAllMode && memoSectionToggle.checked) {
                    playQueue = shuffle(playQueue);
                    currentQueueIndex = 0;
                } else {
                    return endGame();
                }
            }
            
            // Pick Next
            if (isSrsMode) {
                currentWordIndex = getNextSRSWord();
                const unlearned = wordData.filter(w => w.srsLevel < 3);
                if (unlearned.length === 0 && !isReviewAllMode) return endGame();
            } else {
                let item = activeGameMode === 'mixed' ? playQueue[currentQueueIndex] : playQueue[currentQueueIndex];
                currentWordIndex = activeGameMode === 'mixed' ? item.index : item;
            }

            displayWord();
        }

        function updateCombo(success) {
            if (activeGameMode === 'default') return;
            if (success) {
                currentCombo++;
                if(currentCombo > maxCombo) maxCombo = currentCombo;
                comboContainer.classList.add('combo-pop');
                setTimeout(() => comboContainer.classList.remove('combo-pop'), 200);
            } else {
                currentCombo = 0;
            }
            updateComboDisplay();
        }

        function updateComboDisplay() {
            comboValueDisplay.textContent = currentCombo;
            comboContainer.classList.remove('opacity-0');
            comboContainer.className = "transition-opacity font-black text-2xl italic flex items-center gap-2 " + 
                (currentCombo < 5 ? "text-emerald-500" : currentCombo < 10 ? "text-amber-500" : "text-amber-500 combo-fire");
        }

        function revealAnswer(isFailure) {
            isWordRevealed = true;
            flashcardReveal.classList.remove('invisible');
            
            const targetContent = wordData[currentWordIndex][targetColumn];
            targetWordDisplay.innerHTML = ''; // Clear first
            
            // Handle image targets
            if (targetContent.startsWith('data:image')) {
                const img = document.createElement('img');
                img.src = targetContent;
                img.className = 'game-image mx-auto';
                img.title = 'Cliquer pour agrandir';
                targetWordDisplay.appendChild(img);
            } else {
                targetWordDisplay.textContent = targetContent;
            }
            
            const mnemonic = wordData[currentWordIndex]['4'];
            if (mnemonic && mnemonic.trim()) {
                mnemonicText.textContent = mnemonic;
                mnemonicDisplay.classList.remove('hidden');
            }
            
            if (isFailure) {
                isError = true;
                if(!isSrsMode) updateCombo(false);
            } else {
                if (activeGameMode === 'flashcard') updateCombo(false);
            }
        }

        // Button Listeners
        showWordButton.addEventListener('click', () => revealAnswer(false));
        showHintButton.addEventListener('click', () => {
             const w = wordData[currentWordIndex];
             if (w['4']) {
                 mnemonicText.textContent = w['4'];
                 mnemonicDisplay.classList.remove('hidden');
             } else if (w['3']) {
                 alert("Contexte: " + w['3']);
             }
        });

        nextWordButton.addEventListener('click', () => {
            const mode = activeGameMode === 'mixed' ? playQueue[currentQueueIndex].mode : activeGameMode;
            if ((mode === 'typing' || mode === 'cloze') && nextWordButton.innerHTML === 'Valider') {
                const correct = wordData[currentWordIndex][targetColumn].trim().toLowerCase();
                const typed = typingInput.value.trim().toLowerCase();
                
                if (typed === correct) {
                    typingInput.classList.add('border-green-500', 'bg-green-50');
                    if(!isSrsMode) updateCombo(true); 
                    setTimeout(() => nextWord(), 500);
                } else {
                    typingInput.classList.add('border-red-500', 'bg-red-50');
                    revealAnswer(true);
                    nextWordButton.innerHTML = 'Continuer';
                }
            } else if (mode === 'flashcard') {
                if (!isWordRevealed) if(!isSrsMode) updateCombo(true);
                nextWord();
            } else {
                nextWord();
            }
        });

        function displayMC(wordObj) {
            const correct = wordObj[targetColumn];
            const distractors = shuffle(wordData.filter(w => w[targetColumn] !== correct).map(w => w[targetColumn])).slice(0, 3);
            const options = shuffle([correct, ...distractors]);
            multipleChoiceContainer.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'bg-white dark:bg-zinc-800 text-gray-700 dark:text-gray-200 p-4 rounded-xl shadow-sm hover:bg-gray-50 dark:hover:bg-zinc-700 border border-gray-100 dark:border-zinc-700 transition-all font-medium';
                
                if(opt.startsWith('data:image')) {
                    btn.innerHTML = `<img src="${opt}" class="mc-image mx-auto cursor-pointer" title="Cliquer pour agrandir">`;
                    // Make MC images zoomable too
                    btn.querySelector('img').onclick = (e) => {
                        e.stopPropagation();
                        zoomImage(opt);
                    };
                } else {
                    btn.textContent = opt;
                }
                
                btn.onclick = () => {
                    const btns = multipleChoiceContainer.querySelectorAll('button');
                    btns.forEach(b => b.disabled = true);
                    if (opt === correct) {
                        btn.className = 'bg-emerald-500 text-white p-4 rounded-xl shadow-md border border-emerald-600 font-bold';
                        if(!isSrsMode) updateCombo(true);
                        setTimeout(() => nextWord(), 600);
                    } else {
                        btn.className = 'bg-red-500 text-white p-4 rounded-xl shadow-md border border-red-600 font-bold';
                        btns.forEach(b => { if(b.textContent === correct || b.innerHTML.includes(correct)) b.className = 'bg-emerald-500 text-white p-4 rounded-xl border border-emerald-600'; });
                        revealAnswer(true);
                        nextWordButton.classList.remove('hidden');
                    }
                };
                multipleChoiceContainer.appendChild(btn);
            });
        }

        // --- ENDGAME ---
        function stopGameCleanup() {
            gameStarted = false;
            clearInterval(timerInterval);
            if (autoAdvanceTimeout) clearTimeout(autoAdvanceTimeout);
            clearTimeout(masterTimer);
            if (speakTimeoutId) clearTimeout(speakTimeoutId);
            if (window.speechSynthesis) window.speechSynthesis.cancel();
        }

        function endGame() {
            stopGameCleanup();
            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            finalTimeDisplay.textContent = timerDisplay.textContent;
            finalComboDisplay.textContent = maxCombo;
            
            // History
            historyTableBody.innerHTML = '';
            wordTimings.forEach(item => {
                const tr = document.createElement('tr');
                const src = item[sourceColumn].startsWith('data:image') 
                    ? `<img src="${item[sourceColumn]}" class="h-10 mx-auto rounded cursor-pointer hover:opacity-80 transition" onclick="zoomImage('${item[sourceColumn]}')" title="Cliquer pour agrandir">` 
                    : `<span class="text-sm">${item[sourceColumn]}</span>`;
                const tgt = item.targetLabel.startsWith('data:image') 
                    ? `<img src="${item.targetLabel}" class="h-10 mx-auto rounded cursor-pointer hover:opacity-80 transition" onclick="zoomImage('${item.targetLabel}')" title="Cliquer pour agrandir">` 
                    : `<span class="text-sm">${item.targetLabel}</span>`;
                const timeSec = (item.time / 1000).toFixed(2) + 's';
                
                tr.innerHTML = `<td class="p-2 border-b dark:border-zinc-700 text-gray-700 dark:text-gray-300">${src}</td>
                                <td class="p-2 border-b dark:border-zinc-700 text-gray-700 dark:text-gray-300">${tgt}</td>
                                <td class="p-2 border-b dark:border-zinc-700 text-center font-mono text-xs text-gray-500">${timeSec}</td>
                                <td class="p-2 border-b dark:border-zinc-700 text-center">${item.isError ? '‚ùå' : '‚úÖ'}</td>`;
                if(item.isError) tr.classList.add('bg-red-50', 'dark:bg-red-900/20');
                historyTableBody.appendChild(tr);
            });

            // Analytics
            analyticsTableBody.innerHTML = '';
            const agg = {};
            wordTimings.forEach(t => {
                const key = t.targetLabel;
                if (!agg[key]) agg[key] = { errors: 0, time: 0, count: 0 };
                if (t.isError) agg[key].errors++;
                agg[key].time += t.time;
                agg[key].count++;
            });
            const badWords = Object.entries(agg).filter(([k, v]) => v.errors > 0 || (v.time/v.count > 5000))
                                  .sort((a,b) => b[1].errors - a[1].errors || b[1].time - a[1].time);
            
            if (badWords.length === 0) {
                analyticsTableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-emerald-600 dark:text-emerald-400 font-bold">Parfait ! Aucune difficult√© majeure.</td></tr>';
                replayButton.classList.add('hidden');
            } else {
                badWords.forEach(([word, stats]) => {
                    const avgTime = (stats.time / stats.count / 1000).toFixed(1);
                    const tr = document.createElement('tr');
                    const wordDisplay = word.startsWith('data:image') 
                        ? `<img src="${word}" class="h-10 mx-auto rounded cursor-pointer hover:opacity-80 transition" onclick="zoomImage('${word}')" title="Cliquer pour agrandir">`
                        : `<span class="text-sm">${word}</span>`;
                    tr.innerHTML = `<td class="p-3 border-b dark:border-zinc-700 font-bold text-gray-700 dark:text-gray-200">${wordDisplay}</td>
                                    <td class="p-3 border-b dark:border-zinc-700 text-center text-red-500 font-bold">${stats.errors}</td>
                                    <td class="p-3 border-b dark:border-zinc-700 text-center text-gray-500">${avgTime}s</td>`;
                    analyticsTableBody.appendChild(tr);
                });
                replayButton.classList.remove('hidden');
            }
        }

        replaySlowBtn.addEventListener('click', () => {
            const count = parseInt(slowReplayCount.value) || 5;
            const sortedByTime = [...wordTimings].sort((a, b) => b.time - a.time);
            const toReplay = sortedByTime.slice(0, count).map(w => w.id);
            if (toReplay.length === 0) return showCustomAlert("Info", "Pas assez de donn√©es.");
            playQueue = toReplay;
            endScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            currentQueueIndex = 0; currentCombo = 0; maxCombo = 0; wordTimings = [];
            updateComboDisplay();
            gameStarted = true; startTime = performance.now();
            timerDisplay.textContent = "0.000s";
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => { timerDisplay.textContent = ((performance.now() - startTime)/1000).toFixed(3) + 's'; }, 50);
            nextWord(true);
        });

        resetButton.addEventListener('click', () => { stopGameCleanup(); endScreen.classList.add('hidden'); setupScreen.classList.remove('hidden'); });
        returnButton.addEventListener('click', () => { stopGameCleanup(); gameScreen.classList.add('hidden'); setupScreen.classList.remove('hidden'); });

        function handleModeChange() {
             const mode = gameModeSelect.value;
             if (mode === 'default') { srsModeCheckbox.checked = false; srsModeCheckbox.disabled = true; } 
             else { srsModeCheckbox.disabled = false; }
             
             if(srsModeCheckbox.checked) { inOrderCheckbox.disabled = true; inOrderCheckbox.checked = false; } 
             else { inOrderCheckbox.disabled = false; }

             if (['typing','mc','mixed','cloze'].includes(mode)) {
                 numSourceWordsSelect.value = '1'; numSourceWordsSelect.disabled = true;
                 timerModeCheckbox.disabled = true; reviewAllCheckbox.disabled = true;
                 if(mode === 'cloze') showCustomAlert("Mode Trou", "Assurez-vous d'avoir rempli la Colonne 3 !");
             } else {
                 numSourceWordsSelect.disabled = false; timerModeCheckbox.disabled = false; reviewAllCheckbox.disabled = false;
             }
        }
        gameModeSelect.addEventListener('change', handleModeChange);
        numSourceWordsSelect.addEventListener('change', handleModeChange);
        srsModeCheckbox.addEventListener('change', handleModeChange);

        document.addEventListener('keydown', (e) => {
            if (!gameStarted) return;
            if (e.key === 'ArrowRight' && !nextWordButton.classList.contains('hidden')) {
                 if ((activeGameMode === 'typing' || activeGameMode === 'cloze') && nextWordButton.innerHTML === 'Valider') nextWordButton.click(); 
                 else nextWordButton.click();
            }
            if (e.key === 'Enter') {
                if ((activeGameMode === 'typing' || activeGameMode === 'cloze')) nextWordButton.click();
                else if (activeGameMode === 'default' || activeGameMode === 'flashcard') revealAnswer(false);
            }
            if (e.key === ' ' && (activeGameMode === 'default' || activeGameMode === 'flashcard')) {
                if (showWordButton.classList.contains('hidden')) nextWordButton.click();
                else showWordButton.click();
            }
        });

        // --- PWA : Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            // Inline Service Worker via Blob (√©vite d'avoir un fichier s√©par√©)
            const swCode = `
const CACHE = 'jeu-de-mots-v1';
const ASSETS = [self.location.href.replace('sw.js',''), 
    'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap',
    'https://cdn.tailwindcss.com'
];

self.addEventListener('install', e => {
    e.waitUntil(
        caches.open(CACHE).then(cache => {
            return cache.addAll(['/']).catch(() => {});
        })
    );
    self.skipWaiting();
});

self.addEventListener('activate', e => {
    e.waitUntil(
        caches.keys().then(keys => 
            Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
        )
    );
    self.clients.claim();
});

self.addEventListener('fetch', e => {
    e.respondWith(
        caches.match(e.request).then(cached => 
            cached || fetch(e.request).then(res => {
                const clone = res.clone();
                caches.open(CACHE).then(c => c.put(e.request, clone));
                return res;
            }).catch(() => cached)
        )
    );
});`;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).catch(() => {});
        }

        // --- PWA : G√©n√©ration du manifest.json dynamiquement ---
        const manifest = {
            name: "Jeu de Mots - Pro Memory",
            short_name: "Jeu de Mots",
            description: "M√©morisez avec flashcards, quiz et SRS",
            start_url: "./",
            display: "standalone",
            background_color: "#f9fafb",
            theme_color: "#4f46e5",
            orientation: "portrait",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%234f46e5'/%3E%3Ctext y='.9em' font-size='80' x='10'%3Eüß†%3C/text%3E%3C/svg%3E",
                    sizes: "any",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ],
            categories: ["education", "productivity"]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').href = manifestUrl;

    </script>
</body>
</html>
