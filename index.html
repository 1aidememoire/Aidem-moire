<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu de Mots</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .error-row {
            color: #ef4444; /* red-500 */
        }
        .input-cell {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            text-align: center;
            transition: border-color 0.3s;
        }
        .input-cell:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .mode-button {
            @apply px-4 py-2 rounded-full font-medium transition duration-300;
        }
        .mode-button.active {
            @apply bg-blue-500 text-white shadow-md;
        }
        .mode-button.inactive {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        input:disabled {
            @apply bg-gray-200 cursor-not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-4xl text-center flex flex-col items-center">

        <div id="custom-alert" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 id="alert-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="alert-message" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="alert-ok-button" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="setup-screen" class="w-full">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">Préparez le jeu</h1>
            <p class="text-gray-600 mb-6">
                Saisissez vos mots ou collez-les depuis un tableur.
            </p>

            <div class="flex justify-center gap-4 mb-6">
                <button id="paste-mode-btn" class="mode-button active">
                    Coller le texte
                </button>
                <button id="table-mode-btn" class="mode-button inactive">
                    Saisir dans le tableau
                </button>
            </div>
            
            <div id="paste-input-container" class="w-full mb-4">
                <textarea id="word-input-all" class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-gray-700 resize-none" placeholder="Collez ici vos mots (colonnes séparées par des tabulations, lignes par des sauts de ligne)."></textarea>
            </div>

            <div id="table-input-container" class="hidden w-full mb-4">
                <div class="overflow-x-auto w-full">
                    <table id="word-table" class="min-w-full bg-white rounded-lg shadow-inner">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-2 text-center text-sm font-medium text-gray-600">Colonne 1</th>
                                <th class="py-2 px-2 text-center text-sm font-medium text-gray-600">Colonne 2</th>
                                <th class="py-2 px-2 text-center text-sm font-medium text-gray-600">Colonne 3</th>
                                <th class="py-2 px-2 text-center text-sm font-medium text-gray-600">Colonne 4</th>
                                <th class="py-2 px-2 text-center text-sm font-medium text-gray-600">Colonne 5</th>
                            </tr>
                        </thead>
                        <tbody id="word-table-body">
                        </tbody>
                    </table>
                </div>
                <button id="add-row-button" class="mt-4 px-4 py-2 bg-gray-300 text-gray-700 rounded-full shadow-sm hover:bg-gray-400 transition duration-300 text-sm">
                    Ajouter une ligne
                </button>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 w-full mb-4 justify-center items-center">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="typing-mode-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="typing-mode-checkbox" class="text-gray-700">Mode Saisie</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="flashcard-mode-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="flashcard-mode-checkbox" class="text-gray-700">Mode Révision (Flashcard)</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="multiple-choice-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="multiple-choice-checkbox" class="text-gray-700" id="multiple-choice-label">Mode Choix multiples</label>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 w-full mb-4 justify-center items-center">
                <div class="w-full md:w-1/2">
                    <label for="source-column-select" class="block text-sm font-medium text-gray-700 mb-1 text-left">Colonne source</label>
                    <select id="source-column-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-gray-700">
                        <option value="1">Colonne 1</option>
                        <option value="2">Colonne 2</option>
                        <option value="3">Colonne 3</option>
                        <option value="4">Colonne 4</option>
                        <option value="5">Colonne 5</option>
                    </select>
                </div>
                <div class="w-full md:w-1/2">
                    <label for="target-column-select" class="block text-sm font-medium text-gray-700 mb-1 text-left">Colonne cible</label>
                    <select id="target-column-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-gray-700">
                        <option value="2">Colonne 2</option>
                        <option value="1">Colonne 1</option>
                        <option value="3">Colonne 3</option>
                        <option value="4">Colonne 4</option>
                        <option value="5">Colonne 5</option>
                    </select>
                </div>
            </div>

            <div class="w-full mb-4">
                <label for="word-limit" class="block text-sm font-medium text-gray-700 mb-1 text-left">Limiter le nombre de mots (facultatif)</label>
                <input type="number" id="word-limit" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-gray-700" placeholder="Par défaut : tous les mots">
            </div>
            
            <button id="start-button" class="mt-6 px-8 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Lancer le jeu
            </button>
        </div>

        <div id="game-screen" class="hidden w-full">
            <div class="flex justify-between items-center mb-6 w-full">
                <button id="return-button" class="px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-full shadow-sm hover:bg-red-600 transition duration-300">
                    Retour au menu
                </button>
                <div class="text-sm font-medium text-gray-500" id="progress-display"></div>
                <div class="flex items-baseline gap-2">
                    <h2 class="text-xl font-medium text-gray-500">Chronomètre</h2>
                    <div id="timer-display" class="text-2xl font-bold text-gray-900 tabular-nums">0.000s</div>
                </div>
            </div>
            
            <div id="word-display" class="min-h-[100px] flex flex-col items-center justify-center">
                <p class="text-5xl md:text-6xl lg:text-7xl font-bold text-gray-800 break-words max-w-full leading-tight">Mot</p>
                <div id="flashcard-reveal" class="hidden text-xl mt-4 text-gray-600 italic">
                    <span id="target-word-display"></span>
                </div>
            </div>

            <div class="mt-8 w-full flex flex-col items-center">
                <button id="next-word-button" class="mb-4 px-6 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    Mot suivant →
                </button>
                <input type="text" id="typing-input" class="hidden w-full max-w-md p-3 text-center border-2 border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tapez la réponse ici">
                <div id="multiple-choice-container" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-lg mt-4"></div>
                <div id="game-instruction" class="text-gray-500 text-sm mt-4">
                    Utilisez la flèche droite (→) pour passer au mot suivant.
                </div>
            </div>
        </div>

        <div id="end-screen" class="hidden w-full">
            <h2 class="text-3xl font-bold mb-4 text-gray-800">Jeu terminé !</h2>
            <div class="mb-6">
                <span class="text-gray-600 text-lg">Votre temps total : </span>
                <span id="final-time-display" class="text-4xl font-extrabold text-blue-600 tabular-nums">0.000s</span>
            </div>

            <div id="history-container" class="mt-8 overflow-x-auto w-full">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Historique des mots et temps</h3>
                <table class="min-w-full bg-white rounded-lg shadow">
                    <thead class="bg-gray-200">
                        <tr>
                            <th id="history-col-source" class="py-2 px-4 text-left font-medium text-gray-600">Source</th>
                            <th id="history-col-target" class="py-2 px-4 text-left font-medium text-gray-600">Cible</th>
                            <th class="py-2 px-4 text-left font-medium text-gray-600">Autres</th>
                            <th class="py-2 px-4 text-left font-medium text-gray-600">Temps</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mt-8">
                <button id="replay-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Rejouer les mots incorrects
                </button>
                <button id="reset-button" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-full shadow-lg hover:bg-gray-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                    Recommencer
                </button>
            </div>
        </div>

    </div>

    <script>
        // Le code JavaScript reste inchangé.
        // DOM elements
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const pasteInputContainer = document.getElementById('paste-input-container');
        const tableInputContainer = document.getElementById('table-input-container');
        const wordInputAll = document.getElementById('word-input-all');
        const wordTableBody = document.getElementById('word-table-body');
        const addRowButton = document.getElementById('add-row-button');
        const pasteModeBtn = document.getElementById('paste-mode-btn');
        const tableModeBtn = document.getElementById('table-mode-btn');
        const wordLimitInput = document.getElementById('word-limit');
        const startButton = document.getElementById('start-button');
        const timerDisplay = document.getElementById('timer-display');
        const wordDisplay = document.querySelector('#word-display p');
        const finalTimeDisplay = document.getElementById('final-time-display');
        const replayButton = document.getElementById('replay-button');
        const resetButton = document.getElementById('reset-button');
        const historyTableBody = document.getElementById('history-table-body');
        const customAlert = document.getElementById('custom-alert');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOkButton = document.getElementById('alert-ok-button');
        const returnButton = document.getElementById('return-button');
        // New DOM elements for options
        const typingModeCheckbox = document.getElementById('typing-mode-checkbox');
        const flashcardModeCheckbox = document.getElementById('flashcard-mode-checkbox');
        const multipleChoiceCheckbox = document.getElementById('multiple-choice-checkbox');
        const multipleChoiceLabel = document.getElementById('multiple-choice-label');
        const sourceColumnSelect = document.getElementById('source-column-select');
        const targetColumnSelect = document.getElementById('target-column-select');
        const progressDisplay = document.getElementById('progress-display');
        const typingInput = document.getElementById('typing-input');
        const flashcardReveal = document.getElementById('flashcard-reveal');
        const targetWordDisplay = document.getElementById('target-word-display');
        const multipleChoiceContainer = document.getElementById('multiple-choice-container');
        const gameInstruction = document.getElementById('game-instruction');
        const historyColSource = document.getElementById('history-col-source');
        const historyColTarget = document.getElementById('history-col-target');
        const nextWordButton = document.getElementById('next-word-button');
        // Game state variables
        let wordData = [];
        let shuffledIndices = [];
        let currentWordIndex = 0;
        let gameStarted = false;
        let startTime = 0;
        let timerInterval = null;
        let wordTimings = [];
        let wordStartTime = 0;
        let isTypingMode = false;
        let isFlashcardMode = false;
        let isMultipleChoiceMode = false;
        let isFlashcardRevealed = false;
        let isError = false;
        let sourceColumn;
        let targetColumn;

        const columnMap = {
            '1': 'Colonne 1',
            '2': 'Colonne 2',
            '3': 'Colonne 3',
            '4': 'Colonne 4',
            '5': 'Colonne 5',
        };
        // Custom alert function to replace window.alert
        function showCustomAlert(title, message) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
        }

        // Close custom alert
        alertOkButton.addEventListener('click', () => {
            customAlert.classList.add('hidden');
        });
        // Function to switch between input modes
        function setInputMode(mode) {
            if (mode === 'paste') {
                pasteInputContainer.classList.remove('hidden');
                tableInputContainer.classList.add('hidden');
                pasteModeBtn.classList.add('active');
                pasteModeBtn.classList.remove('inactive');
                tableModeBtn.classList.add('inactive');
                tableModeBtn.classList.remove('active');
            } else if (mode === 'table') {
                pasteInputContainer.classList.add('hidden');
                tableInputContainer.classList.remove('hidden');
                pasteModeBtn.classList.add('inactive');
                pasteModeBtn.classList.remove('active');
                tableModeBtn.classList.add('active');
                tableModeBtn.classList.remove('inactive');
            }
            checkMultipleChoiceAvailability();
        }

        // Add event listeners for mode buttons
        pasteModeBtn.addEventListener('click', () => setInputMode('paste'));
        tableModeBtn.addEventListener('click', () => setInputMode('table'));

        // Function to add a new row to the word input table
        function addRow() {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200';
            for (let i = 1; i <= 5; i++) {
                const cell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full input-cell';
                input.setAttribute('data-col', i);
                input.addEventListener('input', checkMultipleChoiceAvailability);
                cell.appendChild(input);
                row.appendChild(cell);
            }
            wordTableBody.appendChild(row);
        }

        // Add 10 initial rows
        for (let i = 0; i < 10; i++) {
            addRow();
        }

        // Event listener for adding a new row
        addRowButton.addEventListener('click', addRow);
        // Check multiple choice availability
        function checkMultipleChoiceAvailability() {
            let currentWordData = [];
            if (!pasteInputContainer.classList.contains('hidden')) {
                const rawInput = wordInputAll.value.trim();
                const rows = rawInput.split('\n');
                currentWordData = rows.map(row => {
                    const cols = row.split('\t');
                    return {
                        '1': cols[0] || '',
                        '2': cols[1] || '',
                        '3': cols[2] || '',
                        '4': cols[3] || '',
                        '5': cols[4] || ''
                    };
                });
            } else {
                const rows = wordTableBody.querySelectorAll('tr');
                currentWordData = Array.from(rows).map(row => {
                    const cells = row.querySelectorAll('input');
                    const rowData = {};
                    cells.forEach(cell => {
                        const col = cell.getAttribute('data-col');
                        rowData[col] = cell.value.trim();
                    });
                    return rowData;
                }).filter(row => Object.values(row).some(val => val !== ''));
            }

            const targetColumnWords = new Set(currentWordData.map(item => item[targetColumnSelect.value]).filter(word => word !== ''));
            const isAvailable = targetColumnWords.size >= 4;

            multipleChoiceCheckbox.disabled = !isAvailable;
            multipleChoiceLabel.classList.toggle('text-gray-400', !isAvailable);
            if (!isAvailable && multipleChoiceCheckbox.checked) {
                multipleChoiceCheckbox.checked = false;
                wordLimitInput.disabled = false;
            }
        }
        
        // Initial check and event listeners for dynamic check
        wordInputAll.addEventListener('input', checkMultipleChoiceAvailability);
        sourceColumnSelect.addEventListener('change', checkMultipleChoiceAvailability);
        targetColumnSelect.addEventListener('change', checkMultipleChoiceAvailability);
        window.addEventListener('load', checkMultipleChoiceAvailability);

        // Fisher-Yates shuffle algorithm
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // Helper function to get random unique distractors for multiple choice
        function getRandomDistractors(correctAnswer, allAnswers) {
            const distractors = new Set();
            while (distractors.size < 3) {
                const randomIndex = Math.floor(Math.random() * allAnswers.length);
                const potentialDistractor = allAnswers[randomIndex];
                if (potentialDistractor !== correctAnswer && !distractors.has(potentialDistractor)) {
                    distractors.add(potentialDistractor);
                }
            }
            return Array.from(distractors);
        }
        
        // Function to start the game
        function startGame(wordsToPlay) {
            if (!wordsToPlay) {
                if (!pasteInputContainer.classList.contains('hidden')) {
                    // Process from paste mode
                    const rawInput = wordInputAll.value.trim();
                    if (rawInput === '') {
                        showCustomAlert('Erreur', 'Veuillez coller des mots pour commencer le jeu.');
                        return;
                    }
                    const rows = rawInput.split('\n');
                    wordData = rows.map(row => {
                        const cols = row.split('\t');
                        return {
                            '1': cols[0] || '',
                            '2': cols[1] || '',
                            '3': cols[2] || '',
                            '4': cols[3] || '',
                            '5': cols[4] || ''
                        };
                    });
                } else {
                    // Process from table mode
                    const rows = wordTableBody.querySelectorAll('tr');
                    wordData = Array.from(rows).map(row => {
                        const cells = row.querySelectorAll('input');
                        const rowData = {};
                        cells.forEach(cell => {
                            const col = cell.getAttribute('data-col');
                            rowData[col] = cell.value.trim();
                        });
                        return rowData;
                    }).filter(row => Object.values(row).some(val => val !== ''));
                }

                const limit = parseInt(wordLimitInput.value);
                if (!isNaN(limit) && limit > 0 && limit < wordData.length) {
                    wordData = wordData.slice(0, limit);
                }

                if (wordData.length === 0) {
                    showCustomAlert('Erreur', 'Le nombre de mots est insuffisant pour démarrer le jeu.');
                    return;
                }
            } else {
                wordData = wordsToPlay;
            }

            // Read selected columns
            sourceColumn = sourceColumnSelect.value;
            targetColumn = targetColumnSelect.value;
            if (sourceColumn === targetColumn) {
                 showCustomAlert('Erreur', 'Les colonnes source et cible doivent être différentes.');
                 return;
            }

            // Read mode selection
            isTypingMode = typingModeCheckbox.checked;
            isFlashcardMode = flashcardModeCheckbox.checked;
            isMultipleChoiceMode = multipleChoiceCheckbox.checked;

            shuffledIndices = shuffle(Array.from({ length: wordData.length }, (_, i) => i));
            
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            endScreen.classList.add('hidden');
            // Configure UI based on mode
            typingInput.classList.add('hidden');
            multipleChoiceContainer.classList.add('hidden');
            flashcardReveal.classList.add('hidden');
            if (isMultipleChoiceMode) {
                nextWordButton.classList.add('hidden');
            } else {
                nextWordButton.classList.remove('hidden');
                nextWordButton.innerHTML = isTypingMode ? 'Valider' : 'Mot suivant →';
            }

            if (isTypingMode) {
                typingInput.classList.remove('hidden');
                gameInstruction.textContent = `Tapez la réponse de la ${columnMap[targetColumn]} et appuyez sur Entrée ou Valider.`;
                typingInput.focus();
            } else if (isMultipleChoiceMode) {
                 multipleChoiceContainer.classList.remove('hidden');
                 gameInstruction.textContent = `Cliquez sur la bonne réponse de la ${columnMap[targetColumn]}.`;
            } else {
                gameInstruction.textContent = `Utilisez la flèche droite (→) pour passer au mot suivant.`;
            }

            currentWordIndex = 0;
            wordTimings = [];
            gameStarted = true;
            startTime = performance.now();
            wordStartTime = performance.now();

            timerInterval = setInterval(updateTimer, 10);

            displayWord();
            // Handle event listeners based on mode
            document.removeEventListener('keydown', handleKeydown);
            document.removeEventListener('keydown', handleTyping);
            
            if (isTypingMode) {
                document.addEventListener('keydown', handleTyping);
            } else {
                document.addEventListener('keydown', handleKeydown);
            }
        }

        // Function to update the timer display
        function updateTimer() {
            const elapsedTime = (performance.now() - startTime) / 1000;
            timerDisplay.textContent = elapsedTime.toFixed(3) + 's';
        }

        // Function to display the current word and set up the interface
        function displayWord() {
            isFlashcardRevealed = false;
            isError = false;
            typingInput.classList.remove('border-red-500');
            typingInput.value = '';

            const currentIndex = shuffledIndices[currentWordIndex];
            wordDisplay.textContent = wordData[currentIndex][sourceColumn];
            wordStartTime = performance.now();
            progressDisplay.textContent = `(${currentWordIndex + 1}/${wordData.length})`;

            flashcardReveal.classList.add('hidden');
            targetWordDisplay.textContent = '';
            multipleChoiceContainer.innerHTML = '';
            if (isTypingMode) {
                nextWordButton.innerHTML = 'Valider';
                gameInstruction.textContent = `Tapez la réponse de la ${columnMap[targetColumn]} et appuyez sur Entrée ou Valider.`;
                typingInput.focus();
                document.removeEventListener('keydown', handleKeydown);
                document.addEventListener('keydown', handleTyping);
            } else if (isMultipleChoiceMode) {
                 displayMultipleChoice();
            } else {
                nextWordButton.innerHTML = 'Mot suivant →';
            }
        }

        // Function to set up the multiple choice buttons
        function displayMultipleChoice() {
            const currentIndex = shuffledIndices[currentWordIndex];
            const correctWord = wordData[currentIndex][targetColumn];
            const allPossibleAnswers = wordData.map(item => item[targetColumn]).filter(word => word !== '');
            const distractors = getRandomDistractors(correctWord, allPossibleAnswers);
            let answers = shuffle([correctWord, ...distractors]);
            
            multipleChoiceContainer.innerHTML = '';
            answers.forEach(answer => {
                const button = document.createElement('button');
                button.textContent = answer;
                button.className = 'bg-gray-200 text-gray-800 p-3 rounded-full font-semibold shadow-md hover:bg-gray-300 transition duration-150';
                button.addEventListener('click', () => handleMultipleChoiceClick(answer, correctWord));
                multipleChoiceContainer.appendChild(button);
            });
        }

        // Function to handle a click on a multiple choice button
        function handleMultipleChoiceClick(clickedAnswer, correctAnswer) {
            if (clickedAnswer === correctAnswer) {
                nextWord();
            } else {
                // Handle incorrect answer
                const timeForWord = performance.now() - wordStartTime;
                const currentIndex = shuffledIndices[currentWordIndex];
                wordTimings.push({ 
                    ...wordData[currentIndex],
                    time: timeForWord,
                    isError: true
                });
                showCustomAlert('Incorrect', `La bonne réponse était : "${correctAnswer}"`);
                currentWordIndex++;
                if (currentWordIndex < shuffledIndices.length) {
                    displayWord();
                } else {
                    endGame();
                }
            }
        }
        
        // Function to reveal the flashcard answer
        function revealFlashcardAnswer() {
            const currentIndex = shuffledIndices[currentWordIndex];
            targetWordDisplay.textContent = wordData[currentIndex][targetColumn];
            flashcardReveal.classList.remove('hidden');
            gameInstruction.textContent = 'Appuyez à nouveau sur la flèche droite (→) pour passer au mot suivant.';
            isFlashcardRevealed = true;
        }

        // Function to advance to the next word or end the game
        function nextWord() {
            const timeForWord = performance.now() - wordStartTime;
            const currentIndex = shuffledIndices[currentWordIndex];
            wordTimings.push({ 
                ...wordData[currentIndex],
                time: timeForWord,
                isError: isError // Make sure to save the error state
            });
            currentWordIndex++;

            if (currentWordIndex < shuffledIndices.length) {
                displayWord();
            } else {
                endGame();
            }
        }
        
        // This function centralizes the action of moving forward (like right arrow)
        function triggerNextAction() {
            if (!gameStarted || isMultipleChoiceMode) return;
            if (isTypingMode && isError) {
                const timeForWord = performance.now() - wordStartTime;
                const currentIndex = shuffledIndices[currentWordIndex];
                wordTimings.push({ 
                    ...wordData[currentIndex],
                    time: timeForWord,
                    isError: true
                });
                currentWordIndex++;
                if (currentWordIndex < shuffledIndices.length) {
                    displayWord();
                } else {
                    endGame();
                }
            } else if (isFlashcardMode) {
                if (isFlashcardRevealed) {
                    nextWord();
                } else {
                    revealFlashcardAnswer();
                }
            } else { // Default mode
                nextWord();
            }
        }

        // Handles checking the typed answer, used by Enter key and button
        function checkTypedAnswer() {
            if (!isTypingMode || isError) return;
            const typedWord = typingInput.value.trim().toLowerCase();
            const currentIndex = shuffledIndices[currentWordIndex];
            const correctWord = wordData[currentIndex][targetColumn].trim().toLowerCase();
            if (typedWord === correctWord) {
                typingInput.classList.remove('border-red-500');
                isError = false; // Ensure isError is false for correct answers
                nextWord();
            } else {
                typingInput.classList.add('border-red-500');
                targetWordDisplay.textContent = wordData[currentIndex][targetColumn];
                flashcardReveal.classList.remove('hidden');
                const instructionText = `Réponse incorrecte. La bonne réponse est : "${wordData[currentIndex][targetColumn]}".`;
                gameInstruction.textContent = instructionText;
                nextWordButton.innerHTML = 'Mot suivant →';
                isError = true;
                document.removeEventListener('keydown', handleTyping);
                document.addEventListener('keydown', handleKeydown);
            }
        }

        // Handles what the button does when clicked
        function handleNextButtonClick() {
            if (isTypingMode) {
                if (isError) {
                    // If an error is already displayed, act like the right arrow
                    triggerNextAction();
                } else {
                    // Otherwise, check the answer
                    checkTypedAnswer();
                }
            } else {
                // For all other modes, act like the right arrow
                triggerNextAction();
            }
        }
        
        // Function to handle key presses (right arrow)
        function handleKeydown(event) {
            if (event.key === 'ArrowRight') {
                triggerNextAction();
            }
        }

        // Function to handle typing input
        function handleTyping(event) {
            if (event.key === 'Enter') {
                checkTypedAnswer();
            }
        }

        // Function to end the game
        function endGame() {
            // MODIFICATION : RETOUR AUTOMATIQUE AU MENU POUR LE MODE CHOIX MULTIPLES
            if (isMultipleChoiceMode) {
                returnToSetup();
                return; // On quitte la fonction pour ne pas afficher l'écran de fin
            }

            gameStarted = false;
            clearInterval(timerInterval);
            document.removeEventListener('keydown', handleKeydown);
            document.removeEventListener('keydown', handleTyping);

            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            finalTimeDisplay.textContent = ((performance.now() - startTime) / 1000).toFixed(3) + 's';
            wordTimings.sort((a, b) => {
                if (a.isError !== b.isError) {
                    return b.isError - a.isError; // Errors first
                }
                return b.time - a.time; // Then by longest time
            });
            populateHistoryTable(wordTimings);

            if (wordTimings.some(item => item.isError)) {
                replayButton.classList.remove('hidden');
                replayButton.textContent = 'Rejouer les mots incorrects';
            } else if (wordTimings.length > 0) {
                replayButton.classList.remove('hidden');
                replayButton.textContent = 'Rejouer les 10 mots les plus longs';
            } else {
                replayButton.classList.add('hidden');
            }
        }

        // Function to populate the history table
        function populateHistoryTable(data) {
            historyTableBody.innerHTML = '';
            historyColSource.textContent = columnMap[sourceColumn];
            historyColTarget.textContent = columnMap[targetColumn];

            data.forEach(item => {
                const otherColumns = Object.keys(item).filter(key => key !== sourceColumn && key !== targetColumn && ['1', '2', '3', '4', '5'].includes(key)).map(key => item[key]);
                
                const row = document.createElement('tr');
                if (item.isError) {
                    row.classList.add('error-row');
                }
                row.className += ' hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="py-2 px-4 whitespace-nowrap">${item[sourceColumn]}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${item[targetColumn]}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${otherColumns.join(', ')}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${(item.time / 1000).toFixed(3)}s</td>
                `;
                historyTableBody.appendChild(row);
            });
        }

        // Function to restart the game
        function handleReplay() {
            let wordsToReplay = [];
            if (wordTimings.some(word => word.isError)) {
                wordsToReplay = wordTimings.filter(word => word.isError);
            } else {
                wordsToReplay = wordTimings.slice(0, 10);
            }

            if (wordsToReplay.length === 0) {
                showCustomAlert('Information', 'Aucun mot à rejouer.');
                return;
            }
            startGame(wordsToReplay.map(item => {
                // We need to clean up the data before replaying
                const cleanItem = {...item};
                delete cleanItem.time;
                delete cleanItem.isError;
                return cleanItem;
            }));
        }
        
        // Function to return to setup screen
        function returnToSetup() {
            if (gameStarted) {
                gameStarted = false;
                clearInterval(timerInterval);
                document.removeEventListener('keydown', handleKeydown);
                document.removeEventListener('keydown', handleTyping);
            }
            setupScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            typingModeCheckbox.checked = false;
            flashcardModeCheckbox.checked = false;
            multipleChoiceCheckbox.checked = false;
            
            timerDisplay.textContent = '0.000s';
            finalTimeDisplay.textContent = '0.000s';

            checkMultipleChoiceAvailability();
        }

        // Event listeners for buttons and checkboxes
        startButton.addEventListener('click', () => startGame());
        replayButton.addEventListener('click', handleReplay);
        resetButton.addEventListener('click', returnToSetup);
        returnButton.addEventListener('click', returnToSetup);
        nextWordButton.addEventListener('click', handleNextButtonClick);

        // Make mode checkboxes mutually exclusive and handle word limit input
        typingModeCheckbox.addEventListener('change', () => {
            if (typingModeCheckbox.checked) {
                flashcardModeCheckbox.checked = false;
                multipleChoiceCheckbox.checked = false;
                wordLimitInput.disabled = false;
            }
        });
        flashcardModeCheckbox.addEventListener('change', () => {
            if (flashcardModeCheckbox.checked) {
                typingModeCheckbox.checked = false;
                multipleChoiceCheckbox.checked = false;
                wordLimitInput.disabled = false;
            }
        });
        multipleChoiceCheckbox.addEventListener('change', () => {
            if (multipleChoiceCheckbox.checked) {
                typingModeCheckbox.checked = false;
                flashcardModeCheckbox.checked = false;
                wordLimitInput.disabled = true;
                wordLimitInput.value = '';
            } else {
                wordLimitInput.disabled = false;
            }
        });
        // Initial check on load
        checkMultipleChoiceAvailability();
    </script>
</body>
</html>