<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu de Mots</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .error-row {
            color: #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
        }
        .tab-button {
            @apply px-4 py-2 font-semibold;
        }
        .tab-button.active {
            @apply border-b-2 border-blue-500 text-blue-600;
        }
        .tab-button.inactive {
            @apply text-blue-500 hover:text-blue-700;
        }
        input:disabled, input[type="checkbox"]:disabled + label {
            @apply bg-gray-200 cursor-not-allowed text-gray-400;
        }
        .correct-answer {
            transition: all 0.2s ease-in-out;
        }
        .incorrect-answer {
             transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-4xl text-center flex flex-col items-center">

        <!-- Alerte personnalisée -->
        <div id="custom-alert" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
            <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 id="alert-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="alert-message" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="alert-ok-button" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Aide modale -->
        <div id="help-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div class="relative mx-auto p-6 border w-full max-w-lg shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-xl text-center leading-6 font-bold text-gray-900">Aide sur le fonctionnement du jeu</h3>
                    <div class="mt-4 px-2 py-3 text-left max-h-[60vh] overflow-y-auto">
                        <p class="text-sm text-gray-700">
                            Ce jeu a pour objectif de vous aider à mémoriser les informations que vous souhaitez connaître : capitale, nombre d'habitants par pays, vocabulaire, dates historiques, grammaire...
                        </p>
                        <p class="text-sm text-gray-700 mt-2">
                            Pour l'utiliser, vous devez avoir renseigné un classeur avec au moins 2 colonnes d'informations liées. Par exemple :
                        </p>
                        <div class="my-4 border rounded-lg overflow-hidden shadow-sm">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="px-4 py-2">Colonne A</th>
                                        <th scope="col" class="px-4 py-2">Colonne B</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-white border-b"><td class="px-4 py-2 font-medium text-gray-900">France</td><td class="px-4 py-2">Paris</td></tr>
                                    <tr class="bg-white border-b"><td class="px-4 py-2 font-medium text-gray-900">Espagne</td><td class="px-4 py-2">Madrid</td></tr>
                                    <tr class="bg-white border-b"><td class="px-4 py-2 font-medium text-gray-900">Allemagne</td><td class="px-4 py-2">Berlin</td></tr>
                                    <tr class="bg-white border-b"><td class="px-4 py-2 font-medium text-gray-900">Irlande</td><td class="px-4 py-2">Dublin</td></tr>
                                    <tr class="bg-white"><td class="px-4 py-2 font-medium text-gray-900">Angleterre</td><td class="px-4 py-2">Londres</td></tr>
                                </tbody>
                            </table>
                        </div>
                         <p class="text-sm text-gray-700 mt-2">
                            Copiez ces informations et collez-les dans la case centrale. Ensuite, activez une des options et lancez le jeu.
                        </p>
                        <ul class="list-disc list-inside text-sm text-gray-700 mt-2">
                            <li>Le <b>mode par défaut</b> vous montre un mot et vous passez au suivant.</li>
                            <li>Le <b>mode Saisie</b> vous demande de taper l'information recherchée.</li>
                            <li>Le <b>mode Choix multiples</b> vous présente 4 options et vous demande de cliquer sur la bonne réponse.</li>
                        </ul>
                        <p class="text-sm text-gray-700 mt-2">
                            Vous pouvez copier jusqu'à 5 colonnes. Le jeu vous permet de déterminer avec lesquelles vous souhaitez travailler.
                        </p>
                         <p class="text-sm text-gray-700 mt-4">
                            Vous pouvez également importer des images. Le format JPEG est fortement recommandé. Le nom des images correspond aux informations de la 2e colonne. Par exemple, si vous ajoutez une photo de serpent intitulée "Reptile", en mode saisie, c'est le mot "Reptile" que vous devrez renseigner.
                        </p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-help-button" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Retour
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Écran de configuration -->
        <div id="setup-screen" class="w-full">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">Préparez le jeu</h1>
            <p id="help-link" class="text-blue-600 cursor-pointer hover:underline mb-6">Aide sur le fonctionnement du jeu</p>
            
            <div class="w-full mb-4">
                <div class="flex justify-around border-b">
                    <button id="text-tab-btn" class="tab-button active">Coller le texte</button>
                    <button id="image-tab-btn" class="tab-button inactive">Importer des images</button>
                </div>
                <div id="text-tab-content" class="pt-4">
                     <textarea id="word-input-all" class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-gray-700 resize-none" placeholder="Collez ici vos mots (colonnes séparées par des tabulations, lignes par des sauts de ligne)."></textarea>
                </div>
                <div id="image-tab-content" class="hidden pt-4">
                    <input type="file" id="image-input" multiple accept="image/jpeg, image/png" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <div id="image-preview-container" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 max-h-64 overflow-y-auto p-2 border rounded-lg bg-gray-50"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full mb-4">
                 <div class="flex items-center space-x-2"><input type="checkbox" id="typing-mode-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="typing-mode-checkbox" class="text-gray-700">Mode Saisie</label></div>
                 <div class="flex items-center space-x-2"><input type="checkbox" id="multiple-choice-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="multiple-choice-checkbox" class="text-gray-700" id="multiple-choice-label">Mode Choix multiples</label></div>
                 <div class="flex items-center space-x-2"><input type="checkbox" id="flashcard-mode-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="flashcard-mode-checkbox" class="text-gray-700">Mode Flashcards</label></div>
                 <div class="flex items-center space-x-2 col-span-1 md:col-span-2"><input type="checkbox" id="review-all-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="review-all-checkbox" class="text-gray-700">Tout revoir en aléatoire pendant</label><input type="number" id="review-all-seconds" min="1" class="w-20 p-1 border border-gray-300 rounded-md" placeholder="ex: 60"><label for="review-all-seconds" class="text-gray-700">secondes</label></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full mb-4">
                 <div class="flex items-center space-x-2"><input type="checkbox" id="in-order-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="in-order-checkbox" class="text-gray-700">Lire dans l'ordre</label></div>
                 <div class="flex items-center space-x-2"><input type="checkbox" id="show-other-cols-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="show-other-cols-checkbox" class="text-gray-700">Afficher les autres données</label></div>
            </div>


            <div class="flex flex-col md:flex-row gap-4 w-full mb-4 justify-center items-center">
                <div class="w-full md:w-1/2"><label for="source-column-select" class="block text-sm font-medium text-gray-700 mb-1 text-left">Colonne source</label><select id="source-column-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-gray-700"><option value="1">Colonne 1</option><option value="2">Colonne 2</option><option value="3">Colonne 3</option><option value="4">Colonne 4</option><option value="5">Colonne 5</option></select></div>
                <div class="w-full md:w-1/2"><label for="target-column-select" class="block text-sm font-medium text-gray-700 mb-1 text-left">Colonne cible</label><select id="target-column-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-gray-700"><option value="2">Colonne 2</option><option value="1">Colonne 1</option><option value="3">Colonne 3</option><option value="4">Colonne 4</option><option value="5">Colonne 5</option></select></div>
            </div>

            <div class="w-full mb-4 flex items-center justify-start gap-4"><label for="word-limit" class="text-gray-700">Limiter le nombre de mots (facultatif)</label><input type="number" id="word-limit" class="w-40 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-gray-700" placeholder="Par défaut : tous les mots"></div>
            
            <button id="start-button" class="mt-6 px-8 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Lancer le jeu</button>
        </div>

        <!-- Écran de jeu -->
        <div id="game-screen" class="hidden w-full">
            <div class="flex justify-between items-center mb-6 w-full"><button id="return-button" class="px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-full shadow-sm hover:bg-red-600 transition duration-300">Retour au menu</button><div class="text-sm font-medium text-gray-500" id="progress-display"></div><div class="flex items-baseline gap-2"><h2 id="chronometer-label" class="text-sm font-medium text-gray-500">Chronomètre</h2><div id="timer-display" class="text-sm font-bold text-gray-900 tabular-nums">0.000s</div></div></div>
            <div id="word-display" class="min-h-[250px] flex flex-col items-center justify-center"><p class="text-5xl md:text-6xl lg:text-7xl font-bold text-gray-800 break-words max-w-full leading-tight">Mot</p></div>
            <div id="flashcard-reveal" class="invisible text-xl my-4 text-gray-600 italic min-h-[56px]"><span id="target-word-display" class="font-bold"></span><div id="other-cols-display" class="hidden text-sm mt-2 text-gray-500"></div></div>
            <div class="mt-2 w-full flex flex-col items-center"><div class="flex justify-center items-center gap-4"><button id="show-word-button" class="hidden mb-4 px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105">Voir le mot</button><button id="next-word-button" class="mb-4 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">Mot suivant →</button></div><input type="text" id="typing-input" class="hidden w-full max-w-md p-3 text-center border-2 border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Tapez la réponse ici"><div id="multiple-choice-container" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-lg mt-4"></div><div id="game-instruction" class="text-gray-500 text-sm mt-4">Utilisez la flèche droite (→) pour passer au mot suivant.</div></div>
        </div>
        
        <!-- Écran de fin -->
        <div id="end-screen" class="hidden w-full">
            <h2 class="text-3xl font-bold mb-4 text-gray-800">Jeu terminé !</h2>
            <div id="review-all-summary" class="hidden text-lg mb-4"></div>
            <div class="mb-6"><span class="text-gray-600 text-lg">Votre temps total : </span><span id="final-time-display" class="text-4xl font-extrabold text-blue-600 tabular-nums">0.000s</span></div>
            <div id="history-container" class="mt-8 overflow-x-auto w-full"><h3 id="history-title" class="text-xl font-semibold mb-4 text-gray-800">Historique des mots et temps</h3><table class="min-w-full bg-white rounded-lg shadow"><thead class="bg-gray-200"><tr><th id="history-col-source" class="py-2 px-4 text-center font-medium text-gray-600">Source</th><th id="history-col-target" class="py-2 px-4 text-center font-medium text-gray-600">Cible</th><th class="py-2 px-4 text-center font-medium text-gray-600">Autres</th><th class="py-2 px-4 text-center font-medium text-gray-600">Temps</th></tr></thead><tbody id="history-table-body" class="divide-y divide-gray-200"></tbody></table></div>
            <div id="replay-options" class="flex items-center justify-center gap-2 mt-4"><label for="replay-longest-count">Revoir les</label><input type="number" id="replay-longest-count" min="1" class="w-20 p-1 border border-gray-300 rounded-md text-center" placeholder="10"><label for="replay-longest-count">mots les plus longs.</label></div>
            <div class="flex flex-col md:flex-row gap-4 mt-8"><button id="replay-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Rejouer</button><button id="reset-button" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-full shadow-lg hover:bg-gray-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Recommencer</button></div>
        </div>

    </div>

    <script>
        // DOM elements
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const wordInputAll = document.getElementById('word-input-all');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const textTabBtn = document.getElementById('text-tab-btn');
        const imageTabBtn = document.getElementById('image-tab-btn');
        const textTabContent = document.getElementById('text-tab-content');
        const imageTabContent = document.getElementById('image-tab-content');
        const wordLimitInput = document.getElementById('word-limit');
        const startButton = document.getElementById('start-button');
        const timerDisplay = document.getElementById('timer-display');
        const wordDisplay = document.querySelector('#word-display p');
        const finalTimeDisplay = document.getElementById('final-time-display');
        const replayButton = document.getElementById('replay-button');
        const resetButton = document.getElementById('reset-button');
        const historyTableBody = document.getElementById('history-table-body');
        const customAlert = document.getElementById('custom-alert');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOkButton = document.getElementById('alert-ok-button');
        const returnButton = document.getElementById('return-button');
        const typingModeCheckbox = document.getElementById('typing-mode-checkbox');
        const multipleChoiceCheckbox = document.getElementById('multiple-choice-checkbox');
        const flashcardModeCheckbox = document.getElementById('flashcard-mode-checkbox');
        const multipleChoiceLabel = document.getElementById('multiple-choice-label');
        const sourceColumnSelect = document.getElementById('source-column-select');
        const targetColumnSelect = document.getElementById('target-column-select');
        const progressDisplay = document.getElementById('progress-display');
        const typingInput = document.getElementById('typing-input');
        const flashcardReveal = document.getElementById('flashcard-reveal');
        const targetWordDisplay = document.getElementById('target-word-display');
        const multipleChoiceContainer = document.getElementById('multiple-choice-container');
        const gameInstruction = document.getElementById('game-instruction');
        const historyColSource = document.getElementById('history-col-source');
        const historyColTarget = document.getElementById('history-col-target');
        const nextWordButton = document.getElementById('next-word-button');
        const chronometerLabel = document.getElementById('chronometer-label');
        const showWordButton = document.getElementById('show-word-button');
        const inOrderCheckbox = document.getElementById('in-order-checkbox');
        const reviewAllCheckbox = document.getElementById('review-all-checkbox');
        const reviewAllSecondsInput = document.getElementById('review-all-seconds');
        const showOtherColsCheckbox = document.getElementById('show-other-cols-checkbox');
        const otherColsDisplay = document.getElementById('other-cols-display');
        const replayLongestCountInput = document.getElementById('replay-longest-count');
        const replayOptionsDiv = document.getElementById('replay-options');
        const historyTitle = document.getElementById('history-title');
        const helpLink = document.getElementById('help-link');
        const helpModal = document.getElementById('help-modal');
        const closeHelpButton = document.getElementById('close-help-button');
        const reviewAllSummary = document.getElementById('review-all-summary');
        
        // Game state variables
        let wordData = [];
        let shuffledIndices = [];
        let currentWordIndex = 0;
        let gameStarted = false;
        let startTime = 0;
        let timerInterval = null;
        let masterTimer = null;
        let wordTimings = [];
        let wordStartTime = 0;
        let isTypingMode = false;
        let isMultipleChoiceMode = false;
        let isFlashcardMode = false;
        let isReviewAllMode = false;
        let isWordRevealed = false;
        let isError = false;
        let sourceColumn;
        let targetColumn;

        const columnMap = { '1': 'Colonne 1', '2': 'Colonne 2', '3': 'Colonne 3', '4': 'Colonne 4', '5': 'Colonne 5' };
        
        // --- MODAL & ALERT FUNCTIONS ---
        function showCustomAlert(title, message) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
        }
        alertOkButton.addEventListener('click', () => customAlert.classList.add('hidden'));
        helpLink.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeHelpButton.addEventListener('click', () => helpModal.classList.add('hidden'));

        // --- SETUP SCREEN LOGIC ---
        textTabBtn.addEventListener('click', () => switchTab('text'));
        imageTabBtn.addEventListener('click', () => switchTab('image'));

        function switchTab(tab) {
            if (tab === 'text') {
                textTabContent.classList.remove('hidden');
                imageTabContent.classList.add('hidden');
                textTabBtn.classList.add('active');
                textTabBtn.classList.remove('inactive');
                imageTabBtn.classList.add('inactive');
                imageTabBtn.classList.remove('active');
            } else {
                textTabContent.classList.add('hidden');
                imageTabContent.classList.remove('hidden');
                textTabBtn.classList.add('inactive');
                textTabBtn.classList.remove('active');
                imageTabBtn.classList.add('active');
                imageTabBtn.classList.remove('inactive');
            }
            checkMultipleChoiceAvailability();
        }

        imageInput.addEventListener('change', (e) => {
            imagePreviewContainer.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'relative p-1 border rounded-md shadow-sm bg-white';
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.className = 'w-full h-20 object-cover rounded';
                    imgContainer.appendChild(img);
                    const name = document.createElement('p');
                    name.textContent = file.name.split('.').slice(0, -1).join('.');
                    name.className = 'text-xs truncate mt-1';
                    imgContainer.appendChild(name);
                    imagePreviewContainer.appendChild(imgContainer);
                };
                reader.readAsDataURL(file);
            });
            checkMultipleChoiceAvailability();
        });

        function checkMultipleChoiceAvailability() {
            let uniqueWords;
            const isImageMode = !imageTabContent.classList.contains('hidden');

            if (isImageMode) {
                const imageFiles = imageInput.files;
                uniqueWords = new Set(Array.from(imageFiles).map(file => file.name.split('.').slice(0, -1).join('.')));
            } else {
                const rawInput = wordInputAll.value.trim();
                const rows = rawInput.split('\n');
                const currentWordData = rows.map(row => row.split('\t')[targetColumnSelect.value - 1] || '').filter(Boolean);
                uniqueWords = new Set(currentWordData);
            }
            
            const isAvailable = uniqueWords.size >= 4;
            multipleChoiceCheckbox.disabled = !isAvailable;
            multipleChoiceLabel.classList.toggle('text-gray-400', !isAvailable);
            if (!isAvailable && multipleChoiceCheckbox.checked) {
                multipleChoiceCheckbox.checked = false;
            }
        }
        wordInputAll.addEventListener('input', checkMultipleChoiceAvailability);
        targetColumnSelect.addEventListener('change', checkMultipleChoiceAvailability);
        
        // --- UTILITY FUNCTIONS ---
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function processImageFiles(files) {
            return Promise.all(Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageName = file.name.split('.').slice(0, -1).join('.');
                        resolve({ '1': e.target.result, '2': imageName, '3': '', '4': '', '5': '' });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }));
        }

        function getRandomDistractors(correctAnswer, allAnswers) {
            const uniqueAnswers = [...new Set(allAnswers)];
            const distractors = new Set();
            const potentialDistractors = uniqueAnswers.filter(answer => answer !== correctAnswer);
            const shuffledDistractors = shuffle(potentialDistractors);
            for (let i = 0; i < Math.min(3, shuffledDistractors.length); i++) {
                distractors.add(shuffledDistractors[i]);
            }
            return Array.from(distractors);
        }
        
        // --- GAME LIFECYCLE ---
        async function startGame(wordsToPlay) {
            if (!wordsToPlay) {
                const isImageMode = !imageTabContent.classList.contains('hidden');
                if (isImageMode) {
                    const imageFiles = imageInput.files;
                    if (imageFiles.length === 0) {
                        showCustomAlert('Erreur', 'Veuillez sélectionner des images.');
                        return;
                    }
                    wordData = await processImageFiles(imageFiles);
                } else {
                    const rawInput = wordInputAll.value.trim();
                    if (rawInput === '') {
                        showCustomAlert('Erreur', 'Veuillez coller des mots.');
                        return;
                    }
                    const rows = rawInput.split('\n');
                    wordData = rows.map(row => {
                        const cols = row.split('\t');
                        return { '1': cols[0] || '', '2': cols[1] || '', '3': cols[2] || '', '4': cols[3] || '', '5': cols[4] || '' };
                    }).filter(item => Object.values(item).some(val => val.trim() !== ''));
                }

                const limit = parseInt(wordLimitInput.value);
                if (!isNaN(limit) && limit > 0 && limit < wordData.length) {
                    wordData = wordData.slice(0, limit);
                }
                if (wordData.length === 0) {
                    showCustomAlert('Erreur', 'Aucun mot valide trouvé.');
                    return;
                }
            } else {
                wordData = wordsToPlay;
            }

            sourceColumn = sourceColumnSelect.value;
            targetColumn = targetColumnSelect.value;
            if (sourceColumn === targetColumn) {
                 showCustomAlert('Erreur', 'Les colonnes source et cible doivent être différentes.');
                 return;
            }
            
            isTypingMode = typingModeCheckbox.checked;
            isMultipleChoiceMode = multipleChoiceCheckbox.checked;
            isFlashcardMode = flashcardModeCheckbox.checked;
            isReviewAllMode = reviewAllCheckbox.checked;

            const indices = Array.from({ length: wordData.length }, (_, i) => i);
            shuffledIndices = inOrderCheckbox.checked && !isReviewAllMode ? indices : shuffle(indices);
            
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            endScreen.classList.add('hidden');
            chronometerLabel.classList.add('hidden');
            
            typingInput.classList.add('hidden');
            multipleChoiceContainer.classList.add('hidden');
            flashcardReveal.classList.add('invisible');
            showWordButton.classList.add('hidden');
            nextWordButton.classList.remove('hidden');
            gameInstruction.classList.toggle('hidden', isMultipleChoiceMode);

            if (isTypingMode) {
                typingInput.classList.remove('hidden');
                nextWordButton.innerHTML = 'Valider';
            } else if (isMultipleChoiceMode) {
                nextWordButton.classList.add('hidden');
                multipleChoiceContainer.classList.remove('hidden');
            } else if (!isReviewAllMode) {
                showWordButton.classList.remove('hidden');
            }

            currentWordIndex = 0;
            wordTimings = [];
            gameStarted = true;
            startTime = performance.now();
            timerInterval = setInterval(updateTimer, 10);
            
            if (isReviewAllMode) {
                const duration = parseInt(reviewAllSecondsInput.value);
                if (isNaN(duration) || duration <= 0) {
                    showCustomAlert('Erreur', 'Veuillez entrer une durée valide.');
                    returnToSetup();
                    return;
                }
                masterTimer = setTimeout(endGame, duration * 1000);
            }

            displayWord();
            document.removeEventListener('keydown', handleKeydown);
            document.removeEventListener('keydown', handleTyping);
            if (isTypingMode) document.addEventListener('keydown', handleTyping);
            else document.addEventListener('keydown', handleKeydown);
        }

        function updateTimer() {
            const elapsedTime = (performance.now() - startTime) / 1000;
            timerDisplay.textContent = elapsedTime.toFixed(3) + 's';
        }

        function displayWord() {
            if (gameStarted && isReviewAllMode && currentWordIndex >= shuffledIndices.length) {
                shuffledIndices = shuffle(shuffledIndices);
                currentWordIndex = 0;
            }
            if (!gameStarted || currentWordIndex >= shuffledIndices.length) return;

            isWordRevealed = false;
            isError = false;
            typingInput.classList.remove('border-red-500', 'bg-red-100', 'border-green-500', 'bg-green-100');
            typingInput.value = '';
            
            const currentIndex = shuffledIndices[currentWordIndex];
            const sourceContent = wordData[currentIndex][sourceColumn];
            
            const displayElement = document.getElementById('word-display');
            if (sourceContent.startsWith('data:image')) {
                displayElement.innerHTML = `<img src="${sourceContent}" class="max-h-60 object-contain mx-auto rounded-lg shadow-md">`;
            } else {
                displayElement.innerHTML = `<p class="text-5xl md:text-6xl lg:text-7xl font-bold text-gray-800 break-words max-w-full leading-tight">${sourceContent}</p>`;
            }

            wordStartTime = performance.now();
            progressDisplay.textContent = `(${currentWordIndex + 1}/${wordData.length})`;
            
            flashcardReveal.classList.add('invisible');
            otherColsDisplay.classList.add('hidden');
            multipleChoiceContainer.innerHTML = '';
             
            if (isTypingMode) {
                nextWordButton.innerHTML = 'Valider';
                typingInput.focus();
            } else if (isMultipleChoiceMode) {
                nextWordButton.classList.add('hidden');
                displayMultipleChoice();
            } else {
                nextWordButton.innerHTML = 'Mot suivant →';
            }
        }

        function displayMultipleChoice() {
            const currentIndex = shuffledIndices[currentWordIndex];
            const correctWord = wordData[currentIndex][targetColumn];
            const allPossibleAnswers = wordData.map(item => item[targetColumn]).filter(Boolean);
            const distractors = getRandomDistractors(correctWord, allPossibleAnswers);
            let answers = shuffle([correctWord, ...distractors]);
            
            multipleChoiceContainer.innerHTML = '';
            answers.forEach(answer => {
                const button = document.createElement('button');
                if (answer.startsWith('data:image')) {
                    button.innerHTML = `<img src="${answer}" class="h-24 w-full object-contain">`;
                    button.className = 'bg-gray-100 p-2 rounded-lg shadow-md hover:bg-gray-200 transition duration-150 flex items-center justify-center';
                } else {
                    button.textContent = answer;
                    button.className = 'bg-gray-200 text-gray-800 p-3 rounded-full font-semibold shadow-md hover:bg-gray-300 transition';
                }
                button.dataset.answer = answer;
                button.addEventListener('click', (e) => handleMultipleChoiceClick(e.currentTarget, answer === correctWord, correctWord));
                multipleChoiceContainer.appendChild(button);
            });
        }
        
        function handleMultipleChoiceClick(clickedButton, isCorrect, correctAnswer) {
            const timeForWord = performance.now() - wordStartTime;
            const currentIndex = shuffledIndices[currentWordIndex];
            
            // Disable all buttons
            const allButtons = multipleChoiceContainer.querySelectorAll('button');
            allButtons.forEach(btn => btn.disabled = true);

            if (isCorrect) {
                clickedButton.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                clickedButton.classList.add('bg-green-500', 'text-white', 'correct-answer');
                wordTimings.push({ ...wordData[currentIndex], time: timeForWord, isError: false });
                setTimeout(nextWord, 800);
            } else {
                isError = true;
                clickedButton.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                clickedButton.classList.add('bg-red-500', 'text-white', 'incorrect-answer');
                
                // Highlight the correct answer
                const correctButton = Array.from(allButtons).find(btn => btn.dataset.answer === correctAnswer);
                if(correctButton) {
                    correctButton.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                    correctButton.classList.add('bg-green-500', 'text-white');
                } else { // Fallback if correct answer not on screen for some reason
                    revealWord();
                }

                wordTimings.push({ ...wordData[currentIndex], time: timeForWord, isError: true });
                nextWordButton.innerHTML = 'Mot suivant →';
                nextWordButton.classList.remove('hidden');
                document.removeEventListener('keydown', handleKeydown);
                document.addEventListener('keydown', handleKeydown);
            }
        }

        function checkTypedAnswer() {
            if (!isTypingMode || isError) return;
            const typedWord = typingInput.value.trim().toLowerCase();
            const currentIndex = shuffledIndices[currentWordIndex];
            const correctWord = wordData[currentIndex][targetColumn].trim().toLowerCase();
            if (typedWord === correctWord) {
                isError = false;
                typingInput.classList.add('border-green-500', 'bg-green-100', 'correct-answer');
                setTimeout(() => {
                     typingInput.classList.remove('border-green-500', 'bg-green-100');
                     nextWord();
                }, 800);
            } else {
                typingInput.classList.add('border-red-500', 'bg-red-100', 'incorrect-answer');
                revealWord();
                nextWordButton.innerHTML = 'Mot suivant →';
                isError = true;
                document.removeEventListener('keydown', handleTyping);
                document.addEventListener('keydown', handleKeydown);
            }
        }

        function revealWord() {
            const currentIndex = shuffledIndices[currentWordIndex];
            const currentWord = wordData[currentIndex];
            const targetContent = currentWord[targetColumn];

            if (targetContent.startsWith('data:image')) {
                targetWordDisplay.innerHTML = `<img src="${targetContent}" class="max-h-24 object-contain mx-auto rounded-lg">`;
            } else {
                targetWordDisplay.textContent = targetContent;
            }

            if (showOtherColsCheckbox.checked) {
                const otherColumns = Object.keys(currentWord).filter(key => key !== sourceColumn && key !== targetColumn && ['1', '2', '3', '4', '5'].includes(key) && currentWord[key]).map(key => currentWord[key]);
                if (otherColumns.length > 0) {
                    otherColsDisplay.innerHTML = otherColumns.join(' / ');
                    otherColsDisplay.classList.remove('hidden');
                }
            }
            flashcardReveal.classList.remove('invisible');
            isWordRevealed = true;
        }

        function nextWord() {
            if (!isTypingMode && !isMultipleChoiceMode) { // Only record time here for non-interactive modes
                 const timeForWord = performance.now() - wordStartTime;
                 const currentIndex = shuffledIndices[currentWordIndex];
                 wordTimings.push({ ...wordData[currentIndex], time: timeForWord, isError: isError });
            } else if (isTypingMode && !isError) { // For typing mode, time is recorded on success
                const timeForWord = performance.now() - wordStartTime;
                const currentIndex = shuffledIndices[currentWordIndex];
                wordTimings.push({ ...wordData[currentIndex], time: timeForWord, isError: false });
            } else if ((isTypingMode || isMultipleChoiceMode) && isError) { // For errors, time is already recorded, just push index
                // Time already recorded in checkTypedAnswer/handleMultipleChoiceClick on error
            }
            currentWordIndex++;

            if (isReviewAllMode) {
                displayWord();
            } else if (currentWordIndex < shuffledIndices.length) {
                displayWord();
            } else {
                endGame();
            }
        }

        function endGame() {
            gameStarted = false;
            clearInterval(timerInterval);
            clearTimeout(masterTimer);
            document.removeEventListener('keydown', handleKeydown);
            document.removeEventListener('keydown', handleTyping);

            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            finalTimeDisplay.textContent = ((performance.now() - startTime) / 1000).toFixed(3) + 's';
            
            replayButton.classList.add('hidden');
            replayOptionsDiv.classList.add('hidden');
            reviewAllSummary.classList.add('hidden');
            
            if (isMultipleChoiceMode) {
                const errorWords = wordTimings.filter(item => item.isError);
                historyTitle.textContent = "Mots avec erreur";
                populateHistoryTable(errorWords);
                if (errorWords.length > 0) {
                    replayButton.textContent = 'Rejouer les mots incorrects';
                    replayButton.classList.remove('hidden');
                }
            } else {
                 if (isReviewAllMode && wordTimings.length > 0) {
                    const aggregatedTimes = new Map();
                    wordTimings.forEach(item => {
                        const key = item['1'] + '||' + item['2'];
                        if (!aggregatedTimes.has(key)) {
                            aggregatedTimes.set(key, { ...item, time: 0, count: 0 });
                        }
                        const entry = aggregatedTimes.get(key);
                        entry.time += item.time;
                        entry.count += 1;
                    });
                    wordTimings = Array.from(aggregatedTimes.values());
                    reviewAllSummary.textContent = `Nombre de mots vus : ${wordTimings.reduce((acc, item) => acc + item.count, 0)}`;
                    reviewAllSummary.classList.remove('hidden');
                }

                wordTimings.sort((a, b) => b.isError - a.isError || b.time - a.time);
                historyTitle.textContent = isReviewAllMode ? "Mots affichés le plus longtemps" : "Historique des mots et temps";
                populateHistoryTable(wordTimings);
                
                const hasErrors = wordTimings.some(item => item.isError);
                const hasWords = wordTimings.length > 0;

                if (hasErrors) {
                    replayButton.textContent = 'Rejouer les mots incorrects';
                    replayButton.classList.remove('hidden');
                } else if (hasWords) {
                    replayButton.textContent = 'Rejouer les mots les plus longs';
                    replayButton.classList.remove('hidden');
                    replayOptionsDiv.classList.remove('hidden');
                }
            }
        }
        
        function populateHistoryTable(data) {
            historyTableBody.innerHTML = '';
            historyColSource.textContent = columnMap[sourceColumn];
            historyColTarget.textContent = columnMap[targetColumn];

            data.forEach(item => {
                const sourceContent = item[sourceColumn];
                const targetContent = item[targetColumn];
                const sourceCell = sourceContent.startsWith('data:image') ? `<td class="py-2 px-4 flex justify-center"><img src="${sourceContent}" class="h-12 w-12 object-cover rounded-md"></td>` : `<td class="py-2 px-4 whitespace-nowrap">${sourceContent}</td>`;
                const targetCell = targetContent.startsWith('data:image') ? `<td class="py-2 px-4 flex justify-center"><img src="${targetContent}" class="h-12 w-12 object-cover rounded-md"></td>` : `<td class="py-2 px-4 whitespace-nowrap">${targetContent}</td>`;
                
                const otherColumns = Object.keys(item).filter(key => key !== sourceColumn && key !== targetColumn && ['1', '2', '3', '4', '5'].includes(key) && item[key]).map(key => item[key]);
                const row = document.createElement('tr');
                if (item.isError) row.classList.add('error-row');
                row.className += ' hover:bg-gray-50 transition duration-150 text-center';
                row.innerHTML = `${sourceCell}${targetCell}<td class="py-2 px-4 whitespace-nowrap">${otherColumns.join(', ') || '-'}</td><td class="py-2 px-4 whitespace-nowrap">${(item.time / 1000).toFixed(3)}s</td>`;
                historyTableBody.appendChild(row);
            });
        }
        
        function returnToSetup() {
            if (gameStarted) {
                gameStarted = false;
                clearInterval(timerInterval);
                clearTimeout(masterTimer);
                document.removeEventListener('keydown', handleKeydown);
                document.removeEventListener('keydown', handleTyping);
            }
            setupScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            chronometerLabel.classList.remove('hidden');
            timerDisplay.textContent = '0.000s';
            checkMultipleChoiceAvailability();
        }

        function triggerNextAction() {
            if (!gameStarted) return;
            // For MC mode, this is only called after a wrong answer via the button's click
            if ((isMultipleChoiceMode || isTypingMode) && isError) {
                 nextWord();
            } else if (isTypingMode) {
                checkTypedAnswer();
            } else if (isFlashcardMode) {
                 if(isWordRevealed) nextWord();
                 else revealWord();
            } else {
                nextWord();
            }
        }

        function handleKeydown(event) {
            if (event.key === 'ArrowRight') triggerNextAction();
        }
        function handleTyping(event) {
            if (event.key === 'Enter') checkTypedAnswer();
        }
        
        function handleReplay() {
            let wordsToReplay = [];
            const hasErrors = wordTimings.some(word => word.isError);
            if (hasErrors) {
                wordsToReplay = wordTimings.filter(word => word.isError);
            } else {
                const count = parseInt(replayLongestCountInput.value) || 10;
                wordsToReplay = wordTimings.slice(0, count);
            }

            if (wordsToReplay.length === 0) {
                showCustomAlert('Information', 'Aucun mot à rejouer.');
                return;
            }
            const cleanWords = wordsToReplay.map(item => { const { time, isError, count, ...word } = item; return word; });
            startGame(cleanWords);
        }

        startButton.addEventListener('click', () => startGame());
        replayButton.addEventListener('click', handleReplay);
        resetButton.addEventListener('click', returnToSetup);
        returnButton.addEventListener('click', returnToSetup);
        nextWordButton.addEventListener('click', triggerNextAction);
        showWordButton.addEventListener('click', revealWord);
        
        const mainModes = [typingModeCheckbox, multipleChoiceCheckbox, flashcardModeCheckbox];
        mainModes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    mainModes.forEach(other => { if (other !== e.target) other.checked = false; });
                }
                handleModeChange();
            });
        });

        reviewAllCheckbox.addEventListener('change', handleModeChange);
        
        function handleModeChange() {
            const isReview = reviewAllCheckbox.checked;
            const isMC = multipleChoiceCheckbox.checked;
            const isAnyMainMode = mainModes.some(cb => cb.checked);

            reviewAllCheckbox.disabled = isAnyMainMode;
            mainModes.forEach(cb => {
                if (cb.id !== 'multiple-choice-checkbox' || !cb.disabled) { // Prevent re-enabling disabled MC checkbox
                     cb.disabled = isReview;
                }
            });
            
            wordLimitInput.disabled = isMC || isReview;
            inOrderCheckbox.disabled = isReview;
            showOtherColsCheckbox.disabled = isMC;
        }
        
        window.addEventListener('load', () => {
            checkMultipleChoiceAvailability();
            handleModeChange();
        });
    </script>
</body>
</html>
